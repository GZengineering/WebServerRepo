<!DOCTYPE html>
<!-- This code was written by Alex Stout for Goal Zero, LLC private use -->
<html lang='en' style= 'background-color:#666666; padding: 0px 25px 25px'>
<head>
    <title>Parameter: Group</title>
    <table width="100%" style="padding-top: 10px">
        <col width = "49%">
        <col width = "51%">
        <tr>
            <td align="left" valign="bottom">
                <button id="button_refresh_data"></button>
            </td>
            <td valign="bottom">
                <h1 align = 'left'> Parameter: Group </h1>
            </td>   
        </tr>
    </table>

    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/resources/dojo.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/form/resources/RangeSlider.css">
        
    <style type="text/css">@import "http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css";
        #ParamGrid 
        {
            height: 36em;
            width: 100%;
        }
        #selectionGrid 
        {
            min-height: 15em;
            width: 100%;
        }
        #GroupGridDiv 
        {
            min-height: 15em;
            width: 100%;
        }
        #membersGrid
        {
            min-height: 10em;
            width: 100%;
        }
        .dojoxGridMasterView
        {
            font-size: 8pt;
        }
        .claro .dojoxGridHeader
        {
            font-size: 8pt;
            font-weight: bold;
            color: #DDDDDD !important;
            background: #333333;
        }
        /*#txtBox_paramFormula
        {
            font-family: Calibri;
            font-size: 9pt;
            min-height: 56px
        }*/
        /*#txtBox_compParamName
        {
            font-family: Calibri;
            font-size: 9pt;
            min-height: 20px
        }*/
        #txtBox_paramName
        {
            min-width: 200pt;
        }
        #button_multiplication
        {
            width: 15px;
        }
        #button_division
        {
            width: 15px;
        }
        #button_addition
        {
            width: 15px;
        }
        #button_subtraction
        {
            width: 15px;
        }
        #button_add_member
        {
            font-size: 12pt;
        }
        #button_remove_member
        {
            font-size: 12pt;
        }
        #reportRangeSlider
        {
            width: 100%
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js" data-dojo-config="async: true, isDebug: true">
    </script>

    <!-- Dojo Execution -->
    <script>
    require(['dojo/_base/lang', 
        'dojox/grid/DataGrid' , 
        'dojo/data/ItemFileWriteStore',
        "dojo/_base/array",
        'dijit/registry',
        'dojo/_base/xhr', 
        'dojox/grid/_CheckBoxSelector',
        'dojox/form/RangeSlider',
        'dijit/form/HorizontalRule',
        'dijit/form/HorizontalRuleLabels',
        'dijit/form/RadioButton',
        'dijit/form/Select',
        "dijit/form/Button",
        "dijit/form/TextBox",
        "dijit/form/Textarea",
        'dojo/store/Observable',
        'dojo/store/Memory',
        'dojo/data/ObjectStore',
        'dojo/dom' , 
        'dojo/domReady!'],
        function(lang, DataGrid, ItemFileWriteStore, baseArray, registry, xhr, _CheckBoxSelector, RangeSlider, HorizontalRule, HorizontalRuleLabels, RadioButton, Select, Button, TextBox, Textarea, Observable, Memory, ObjectStore, dom)
        {
            var fields = new Array();
            var has_loaded = false;

            /*  CREATE A DATA STORE TO CONTAIN ALL THE CONTENT OF THE SERVER  */
            var fullDbMemStore = new Memory({data: new Array()});
                fullDbMemStore = Observable(fullDbMemStore);
                var fullDataStore = new ObjectStore({
                    objectStore: fullDbMemStore
                });
            window.fullDbMemStore = fullDbMemStore; //MAKE IT GLOBAL


            //MEMORY AND DATA STORES FOR TEMPORARY MEMBERS
            var membersStore = new Memory({data: new Array(), idProperty: 'name'});
                membersStore = Observable(membersStore);
            var membersDataStore = new ObjectStore({
                objectStore: membersStore
            });
            window.membersStore = membersStore;
            window.membersDataStore = membersDataStore;

            /*  FUNCTION TO GET ALL THE DB DATA AND FILL THE DATA STORE  */
            init = function()
            {
                xhr.get(
                {
                    url:'/global',
                    handleAs: 'json',
                    content:
                    {
                        action: 'getAll',
                        loaded: has_loaded = true,
                    },
                    load: function(response)
                    {
                        fullDbMemStore.data = response;
                        BuildGrids();
                    },
                    error: function(error)
                    {
                        var msg = 'There was an error getting the db. Error: ' + error;
                        dom.byId("serverResponse").innerHTML = 'Response: ' + msg;
                        console.log(msg);
                    }
                });
            }

            /*  BUILDS THE GRIDS USING THE COLLECTED AND ORGANIZED DATA  */
            function BuildGrids()
            {
                var groups = GroupGrid.getGroups();
                GroupGrid.buildGrid(groups);
                // ParamGrid.buildGrid();
                SelectionGrid.buildGrid(new Array());
                MembersGrid.buildGrid(new Array());
                dom.byId('txtBox_groupName').value = ''; //clear name text box
            }


            /********************************     Group Grid      *********************************/

            //GLOBAL GROUPGRID OBJECT TO ASSOCIATE ITS FUNCTIONS AND MEMBERS
            var GroupGrid = new Object();

            //GET AND RETURN THE GROUPS FROM THE STORE
            GroupGrid.getGroups = function()
            {
                var groups = fullDbMemStore.query({type: 'pg'});
                return groups;
            }

            //BUILD THE DOJO GRID WITH THE GIVEN ARRAY OF GROUPS
            GroupGrid.buildGrid = function(groups)
            {
                //DEFINE THE LAYOUT
                var layout = [[
                  {'name': 'Group', 'field': 'name', 'width': '100%'},
                ]];

                //ALLOCATE THE STORE
                var GroupMemStore = new Memory({data: new Array()}); //set up the store
                GroupMemStore = Observable(GroupMemStore);
                var GroupDataStore = new ObjectStore({
                    objectStore: GroupMemStore
                });
                
                //Fill the store with the retrieved DB data
                for(var i = 0; i < groups.length; i++)
                {
                    GroupMemStore.add(groups[i]);
                }

                registry.remove('GroupGridDiv');

                /*create a new grid*/
                var grid = new DataGrid({
                    store: GroupDataStore,
                    structure: layout,
                    autoHeight: 30,
                    selectionMode: 'single',
                    }, 'GroupGridDiv');
                grid.startup(); //RENDER

                dojo.connect(GroupMemStore, 'notify', function(){grid._refresh()});
                

                //UPDATE THE GROUP SELECTION AND DISPLAY IT IN THE RESPONSE DIV
                function reportSelection(node)
                {
                    //STORE THE SELECTED ITEMS
                    var groups = this.selection.getSelected();
                    GroupGrid.selected_groups = groups;

                    var group = groups[0];

                    if(!group)
                    {
                        return;
                    }

                    //GET THE PIs OF THE SELECTED GROUP & REBUILD THE SELECTION STORE
                    // var parameters = GroupGrid.getFieldsOfGroups(groups);
                    var parameters = group.members;
                    SelectionGrid.rebuildStore(parameters);

                    /*  DISPLAY WHAT'S SELECTED IN THE PROMPT  */
                    if(groups.length < 1)
                        return;

                    var msg = "You have selected " + ((groups.length > 1) ? " ": " ");
                    //FOR EACH PG IN GROUPS, GET THE PG_NAME AND PUT IT IN AN ARRAY 
                    var names = [];
                    for(var i = 0; i < groups.length; i++)
                    {
                        if(!groups[i])
                            return;
                        names.push(groups[i].name);
                    }

                    //UPDATE RESPONSE DIV
                    node.innerHTML = msg + names.join(", ");
                }
                
                //On selection change, call reportSelection() and pass in the response dom
                grid.on("SelectionChanged", 
                    lang.hitch(grid, reportSelection, dom.byId("serverResponse")), true);


                //MAP THE BACKSPACE AND DELETE KEYS TO THE DELETE GROUP BUTTON
                dojo.connect(grid,"onKeyUp", function(e)
                {
                    if(e.keyCode == 46 || e.keyCode == 8)
                    {
                        button_delete_group.onClick();
                    }
                });

                //make the following properties global
                window.GroupData = GroupMemStore.data;
                window.groupGrid = grid;
                window.GroupDataStore = GroupDataStore;
                window.GroupMemStore = GroupMemStore;
            }


            GroupGrid.new_pg = function(pg)
            {
                //send request to create a new PG
                xhr.get(
                {
                    url:"/group", 
                    handleAs: 'json',
                    content: 
                    {
                        action: 'new_pg',
                        pg: JSON.stringify(pg),
                        loaded: has_loaded=true,
                    },
                    load:function(response)
                    {
                        if(objectIsEmpty(response))
                        {
                            dom.byId("serverResponse").innerHTML = "Response from server: " + pg.name + " Already Exists.";
                            return;
                        }
                        dom.byId("serverResponse").innerHTML = "Response from server: " + pg.name + " successfully added.";
                        ClearTextFields();
                        GroupMemStore.add(pg);
                    },
                    error:function(error)
                    {
                        console.log("There was an error: \n"+error);
                        dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                    }
                });
            }


            //Removes an entire group from the database given the id of the row
            //of the selected group
            GroupGrid.removePG = function(selected)
            {
                //IF SELECTED IS NULL OR EMPTY, BAIL
                if(!selected)
                    return;

                //IF THE FIRST ITEM IS NULL, BAIL AND NOTIFY
                if(!selected[0]){ return alert('error deleting '+selected[0].name+' from Parameter Grid');}

                //IF THE USER DOESN'T CONFIRM THEIR WISH TO REMOVE THE SELECTED ITEM, BAIL
                if(!confirm("Are you sure you want to delete \'" + selected[0].name +"\'?"))
                    return;

                //OTHERWISE, SEND THE REQUEST TO REMOVE THE ITEM
                else
                {
                    xhr.get(
                    {
                        url:"/group",
                        content: 
                        {
                            action: 'remove_pg',
                            pg: JSON.stringify(selected[0]),
                            loaded: has_loaded=true,
                        },
                        load:function(response)
                        {
                            dom.byId("serverResponse").innerHTML = "Response from server: " + response;
                            GroupMemStore.remove(selected[0].id);
                        },
                        error:function(error)
                        {
                            console.log("There was an error: \n"+error);
                            dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                        }
                    });
                }
            }

            //UPDATES THE GIVEN GROUP. AN UPDATE IS EITHER A REMOVAL OR ADDITION OF A PARAMETER TO/FROM A GROUP
            GroupGrid.update_pg = function(pg)
            {
                //store the store id of the object
                var id = pg.id;
                //delete the id from the object so it doesn't get stored in the db
                delete pg.id;

                console.log(pg);
                //send request to update an existing PG
                xhr.get(
                {
                    url:"/group", 
                    content: 
                    {
                        action: 'update_pg',
                        pg: JSON.stringify(pg),
                        loaded: has_loaded=true,
                    },
                    load:function(response)
                    {
                        //if an update is successful, we'll receive a message, notify the user.
                        alert(response);
                        dom.byId("serverResponse").innerHTML = "Response from server: " + pg.name + " successfully upated.";
                        // ClearTextFields(); //clear text fields
                        GroupMemStore.remove(id); //remove the old group from the store
                        GroupMemStore.add(pg);
                        groupGrid.selection.clear(); //clear the selection
                        selectionMemStore.setData(new Array());
                        membersGrid.selection.clear();
                        selectionGrid._refresh();
                    },
                    error:function(error)
                    {
                        //log and alert the user of any error
                        console.log("There was an error: \n"+error);
                        alert("There was an error updating " + pg.name);
                        dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                    }
                });
            }


            //GETS AND RETURNS ALL THE PIs OF THE GIVEN PGs
            GroupGrid.getFieldsOfGroups = function(pgs)
            {
                //IF THE GIVEN ARRAY IS EMPTY, RETURN AN EMPTY ARRAY
                if(pgs.length < 1)
                    return new Array();

                //CREATE AN ARRAY TO STORE REALIZED PIs
                var parameters = [];

                //FOR EACH GROUP IN THE GIVEN PGs, MATCH THE PI IDs TO IDs IN THE STORE
                //IF A MATCH IS FOUND, ADD IT TO THE STORE AND MOVE TO THE NEXT PI
                for(var h = 0; h < pgs.length; h++)
                {   
                    //STORE THE CURRENT PG
                    var pg = pgs[h];

                    //IF THE PG IS NULL, BAIL
                    if(!pg)
                        return;

                    for(var i = 0; i < pg.members.length; i++)
                    {
                        //FLAGS IF A MATCH IS FOUND
                        var matched = false;
                        for(var j = 0; j < paramStore.data.length; j++)
                        {
                            if(matched)
                                break;
                            //TRY TO MATCH THE CURRENT PI ID TO AN ID IN THE STORE
                            if(pg.members[i] == paramStore.data[j]._id)
                            {
                                //IF THERE'S A MATCH, PUSH THE PI OBJECT TO THE ARRAY
                                parameters.push(paramStore.data[j]);
                                matched = true;
                            }
                        }
                    }
                }
                return parameters;
            }

            /********************************      End Group Grid      ********************************/

            /********************************  **  **  **  **  **  **  ********************************/

            /**********************************     MEMBERS GRID      *********************************/

            //OBJECT TO ASSOCIATE MEMBER GRID PROPERTIES AND FUNCTIONS
            var MembersGrid = {};

            MembersGrid.buildGrid = function(parameters)
            {
                //DEFINE THE LAYOUT
                var layout = [{type: 'dojox.grid._CheckBoxSelector'},[
                  {'name': 'Parameter', 'field': 'name', 'width': '5em'},
                  {'name': 'Formula', 'field': 'formula', 'width': '70%', editable: true},
                  {'name': 'Range', 'field': 'range', 'width':'3em', editable: true},
                ]];

                //SET MEMBERS STORE DATA TO THE PASSED MEMBERS
                membersStore.setData(parameters);

                registry.remove('membersGrid');

                //CREATE THE DOJO GRID AND RENDER IT
                var grid = new DataGrid({
                    store: membersDataStore,
                    structure: layout,
                    autoHeight: 22,
                selectionMode: 'multiple'}, 'membersGrid');
                grid.startup(); //RENDER

                //REGISTER NOTIFY EVENT TO REFRESH THE GRID
                dojo.connect(membersStore, 'notify', function(){grid._refresh()});

                //GLOBALIZE STORE DATA AND THE GRID
                window.membersGrid = grid;
            }

            /******************************     END STANDARD MEMBERS GRID      *********************************/


            /*******************************    BEGIN SELECTION GRID    ******************************/

            //OBJECT TO ASSOCIATE ALL FUNCTIONS AND PROPERTIES OF THE SELECTION GRID
            var SelectionGrid = new Object();
            
            /*  BUILD THE GRID GIVEN THE PIs AS A PARAMETER  */
            SelectionGrid.buildGrid = function(parameters)
            {
                /*  DEFINE LAYOUT  */
                var layout = [[
                  {'name': 'Parameter', 'field': 'name', 'width': '25%', editable: true},
                  {'name': 'Formula', 'field': 'formula', 'width': '75%', editable: true},
                  {'name': 'Range', 'field': 'range', 'width': '3em', editable: true},
                ]];

                /*  SET UP DATA STORE  */
                var selectionMemStore = new Memory({data: parameters, idProperty: 'name'});
                selectionMemStore = Observable(selectionMemStore);
                var selectionDataStore = new ObjectStore({
                    objectStore: selectionMemStore
                });


                registry.remove('selectionGrid');


                /*  CREATE THE DOJO GRID AND RENDER IT  */
                var selectionGrid = new DataGrid({
                    store: selectionDataStore,
                    structure: layout,
                    selectionMode: 'single',
                    autoHeight: 25,
                    loadingMessage: 'Loading Content'}, "selectionGrid");
                selectionGrid.startup();

                /*  GLOBALIZE GRID PROPERTIES  */
                window.selectionGrid = selectionGrid;
                window.selectionMemStore = selectionMemStore;
            }

            /*  REMOVE A PARAMETER FROM A GROUP  */
            SelectionGrid.removeParameterFromGroup = function(group, parameter)
            {
                selectionMemStore.remove(parameter.name); //remove the parameter from the selection store
                for(var i = 0; i < group.members.length; i++)
                {
                    if(group.members[i].name == parameter.name)
                    {
                        group.members.splice(i, 1);
                    }
                }
                // group.members = []; //clear teh group's members
                var store = selectionMemStore.data; // simplify the store reference
                //for each item in the selection store, put the item in the group members
                // for(var i = 0; i < store.length; i++)
                // {
                //     store[i].id = i;
                //     group.members.push(store[i]);
                // }
                console.log(group);
                //send the update to the db
                GroupGrid.update_pg(group);
            }

            /*  ON SELECTION CHANGE OF THE GROUP GRID, THE SELECTION GRID STORE IS REPOPULATED  */
            SelectionGrid.rebuildStore = function(parameters)
            {
                //IF THERE ARE NO PIs, GET OUT
                if(!parameters)
                    return;
                selectionMemStore.setData(parameters);
                selectionGrid._refresh();
            }


            /********************************     End Selection Grid      *********************************/


            /********************************     Text Boxes, buttons, etc.      *********************************/


            //Group Name Textbox
            var txtBox_groupName = new TextBox({style: "width: 100%"}, "txtBox_groupName");
            var txtBox_paramFormula = new Textarea({style: 'width:100%; min-height:50px'},"txtBox_paramFormula");
            var txtBox_compParamName = new Textarea({style: "width: 100%; max-height: 20px"},"txtBox_compParamName");

            //REGISTER THE ENTER KEY TO SUBMIT A NEW PG
            dojo.connect(txtBox_groupName, "onKeyUp", function(e)
            {
                if(e.keyCode == 13)
                    button_newPG.onClick();
            });

            //REGISTER THE RETURN KEY TO THE COMMIT BUTTON FOR THE PARAMETER NAME TEXTBOX
            dojo.connect(txtBox_compParamName, "onKeyUp", function(e)
            {
                if(e.keyCode == 13)
                    button_add_pi_to_members.onClick();
            });

            //REGISTER THE RETURN KEY TO THE COMMIT BUTTON FOR THE PARAMETER NAME TEXTBOX
            dojo.connect(txtBox_paramFormula, "onKeyUp", function(e)
            {
                if(e.keyCode == 13)
                    button_add_pi_to_members.onClick();
            });

            //Confirm selection button for new group
            //require a name for the group
            var button_newPG = new Button(
            {
                label: 'Commit New Group',
                onClick: function()
                {
                    var group = {}; //CREATE A NEW PG OBJECT
                    group.name = dom.byId('txtBox_groupName').value;
                    group.name = group.name.replace(/(^\s+|\s+$)/g, '');

                    //make sure the name is simple and exists
                    if(group.name < 1)
                        return alert('A name is required for the new group.');

                    if(membersStore.data.length < 1)
                        return alert('You must add one or more parameters to the group.');

                    group.members = [];

                    for(var i = 0; i < membersStore.data.length; i++)
                    {
                        var mem_to_add = membersStore.data[i];

                        //Add regex here to check that range is of the correct form [1-4]'-'[1-4];

                        var param = {};
                        param.id = group.members.length;
                        param.type = "p";
                        param.name = mem_to_add.name;
                        param.formula = mem_to_add.formula;
                        param.range = mem_to_add.range;
                        // param.dependencies = "STUB"; /* PARSE THE FORMULA TO GET THE DEPENDENCIES */
                        group.members.push(param);
                    }
                    console.log(group);
                    GroupGrid.new_pg(group);
                }
            }, "button_newPG");

            //BUTTON USED TO ADD MEMBERS TO AN EXISTING GROUP
            var button_add_to_selected_group = new Button(
            {
                label: "Add Selected Members To Selected Group &#8594",
                onClick: function()
                {
                    //GET THE SELECTED GROUP
                    var selected = groupGrid.selection.getSelected();
                    var group = selected[0];
                    if(!group)
                        return alert("Select a group to add the paramters to.");
                    console.log(group);

                    selected = membersGrid.selection.getSelected();
                    if(!selected || selected.length < 1)
                        return alert("Select Members from the 'Working Members' grid to add to the selected Group.");

                    //FOR EACH ITEM IN THE MEMBERS STORE, MAKE SURE IT'S NOT ALREADY IN THE GROUP AND ADD IT
                    for(var i = 0; i < selected.length; i++)
                    {
                        var matched = false; //flag if there's a match
                        mem_to_add = selected[i];
                        delete mem_to_add._id;
                        for(var j = 0; j < group.members.length; j++)
                        {
                            if(mem_to_add.name == group.members[j].name)
                            {
                                matched = true; //if we find it exists, stop looking and don't add it
                                break;
                            }
                        }
                        if(!matched)
                        { //if we don't find it in the group, add it
                            // var _range = mem_to_add.range.split("-");
                            var id = 0;
                            if(group.members[group.members.length-1].id)
                            {
                                id = group.members[group.members.length-1].id+1
                            }
                            var param = {};
                            param.id = id;
                            param.type = "p";
                            param.name = mem_to_add.name;
                            param.formula = mem_to_add.formula;
                            param.range = mem_to_add.range;
                            group.members.push(param);
                        }
                    }
                    console.log(group);
                    //send the update to the db
                    GroupGrid.update_pg(group);
                }
            }, "button_add_to_selected_group");

            var button_clone_group = new Button(
            {
                label: "Clone",
                onClick: function()
                {
                    var selected = groupGrid.selection.getSelected();
                    if(!selected || selected.length != 1)
                        return alert("Select a group to clone.");

                    var group = selected[0];
                    var suggestion = group.name + " [copy]";
                    var name = prompt("Give a name for the clone of \'" + group.name +"\'.", suggestion);
                    if(!name)
                        return;
                    name = name.replace(/(^\s+|\s+$)/g, '');
                    if(name.length < 1)
                        return alert("Be a little more creative with your name.");

                    var copy = {};
                    copy.name = name;
                    copy.type = 'pg';
                    copy.members = group.members;
                    GroupGrid.new_pg(copy);
                }
            }, "button_clone_group");


            //button to delete a selected group
            var button_delete_group = new Button(
                {
                    label: 'Delete', 
                    onClick: function()
                    {
                        GroupGrid.removePG(GroupGrid.selected_groups);
                    }
                }, "button_delete_group");

            //button to delete a selected parameter from the selected group
            var button_removeParameter = new Button(
                {
                    label: 'Delete', 
                    onClick: function()
                    {
                        var group = GroupGrid.selected_groups[0];
                        var selected_parameters = selectionGrid.selection.getSelected();
                        var parameter = selected_parameters[0];
                        SelectionGrid.removeParameterFromGroup(group, parameter);
                    }
                }, "button_removeParameter");

            //button to delete a selected parameter from the selected group
            var button_removeWorkingMember = new Button(
                {
                    label: 'Delete Selected', 
                    onClick: function()
                    {
                        var selected = membersGrid.selection.getSelected();
                        for(var i = 0; i < selected.length; i++)
                        {
                            if(!selected[i])
                                continue;
                            membersStore.remove(selected[i].name);
                        }
                    }
                }, "button_removeWorkingMember");


            //BUTTON THAT WILL GET THE LATEST DATA FROM THE DATABASE AND REPOPULATE THE GRIDS
            var button_refresh_data = new Button(
            {
                label: 'Refresh All Data',
                onClick: function()
                {
                    init();
                }
            }, "button_refresh_data");

            //BUTTON TO REMOVE A FIXED PI
            var button_multiplication = new Button(
            {
                label: '&#8727', 
                onClick: function()
                {
                    if(dom.byId("txtBox_paramFormula").value == "")
                        dom.byId("txtBox_paramFormula").value = '*'; 
                    else if(dom.byId("txtBox_paramFormula").value[dom.byId("txtBox_paramFormula").value.length-1] == ';')
                        dom.byId("txtBox_paramFormula").value += '*';
                    else
                        dom.byId("txtBox_paramFormula").value += ';' + '*';   
                },
            }, 'button_multiplication');

            //BUTTON TO REMOVE A FIXED PI
            var button_division = new Button(
            {
                label: '/', 
                onClick: function()
                {
                    if(dom.byId("txtBox_paramFormula").value == "")
                        dom.byId("txtBox_paramFormula").value = '/'; 
                    else if(dom.byId("txtBox_paramFormula").value[dom.byId("txtBox_paramFormula").value.length-1] == ';')
                        dom.byId("txtBox_paramFormula").value += '/';
                    else
                        dom.byId("txtBox_paramFormula").value += ';' + '/';   
                },
            }, 'button_division');

            //BUTTON TO REMOVE A FIXED PI
            var button_addition = new Button(
            {
                label: '+', 
                onClick: function()
                {
                    if(dom.byId("txtBox_paramFormula").value == "")
                        dom.byId("txtBox_paramFormula").value = '+'; 
                    else if(dom.byId("txtBox_paramFormula").value[dom.byId("txtBox_paramFormula").value.length-1] == ';')
                        dom.byId("txtBox_paramFormula").value += '+';
                    else
                        dom.byId("txtBox_paramFormula").value += ';' + '+';   
                },
            }, 'button_addition');

            //BUTTON TO REMOVE A FIXED PI
            var button_subtraction = new Button(
            {
                label: '&#8722', 
                onClick: function()
                {
                    if(dom.byId("txtBox_paramFormula").value == "")
                        dom.byId("txtBox_paramFormula").value = '-'; 
                    else if(dom.byId("txtBox_paramFormula").value[dom.byId("txtBox_paramFormula").value.length-1] == ';')
                        dom.byId("txtBox_paramFormula").value += '-';
                    else
                        dom.byId("txtBox_paramFormula").value += ';' + '-';   
                },
            }, 'button_subtraction');


            //CONSTRUCTS A PI FROM THE COMPUTED FORMULA AND NAME FIELDS
            var button_add_pi_to_members = new Button(
            {
                label: 'Add To Group &#8594',
                onClick: function()
                {
                    if(dom.byId("txtBox_compParamName").value < 1)
                        return alert("Define a name for the parameter.")

                    var name = dom.byId("txtBox_compParamName").value;
                    name = name.replace(/(^\s+|\s+$)/g, '');

                    var formula = dom.byId("txtBox_paramFormula").value;
                    formula = formula.replace(/(^\s+|\s+$)/g, '');

                    var range_x = reportRangeSlider.value[0];
                    var range_y = reportRangeSlider.value[1];

                    var param = {};
                    param.type = "p";
                    param.name = name;
                    param.formula = formula;
                    param.range = range_x+"-"+range_y;
                    // param.dependencies = "STUB"; /* PARSE THE FORMULA TO GET THE DEPENDENCIES */

                    try
                    {
                        membersStore.add(param);
                        dom.byId("txtBox_compParamName").value = "";
                        dom.byId("txtBox_paramFormula").value = "";
                    }
                    catch(error){alert("'"+param.name + "' Already exists in the working members")}
                }
            },'button_add_pi_to_members');


            //ADDS THE SELECTED PARAMETER FROM THE WORKING MEMBERS GRID TO THE WORKING FORMULA
            //REQUIRES ONE AND ONLY ONE PARAMETER TO BE SELECTED FROM THE MEMBERS GRID
            //AND REQUIRES A NAME FOR THE GROUP TO BE PROVIDED
            var button_add_parameter_to_formula = new Button(
            {
                label: '&#8595 Add Selected Member To Formula',
                onClick: function()
                {
                    var selected = membersGrid.selection.getSelected();

                    if(!selected[0])
                        return alert('Select a Parameter from the Members Grid to Copy.');

                    if(selected.length != 1)
                        return alert("Select only one parameter to add to the formula.");

                    var param_name = selected[0].name;

                    if(txtBox_groupName.value.length < 1)
                        return alert("Give the working group a name before adding computed parameters");

                    var group_name = txtBox_groupName.value;
                    group_name = group_name.replace(/(^\s+|\s+$)/g, '');

                    membersGrid.selection.clear();

                    add_param_to_formula(group_name, param_name);
                }
            }, "button_add_parameter_to_formula");


            //
            var button_group_commit_changes = new Button(
            {
                label: 'Commit Changes',
                onClick: function()
                {
                    var group = groupGrid.selection.getSelected();
                    group = group[0];
                    // var copy = {};
                    // copy._id = group._id;
                    // copy.type = 'pg';
                    // copy.name = group.name;
                    // copy.members = [];
                    group.members = [];

                    for(var i = 0; i < selectionMemStore.data.length; i++)
                    {
                        var mem_to_add = selectionMemStore.data[i];

                        //Add regex here to check that range is of the correct form [1-4]'-'[1-4];

                        var param = {};
                        param.id = mem_to_add.id;
                        param.type = "p";
                        param.name = mem_to_add.name;
                        param.formula = mem_to_add.formula;
                        param.range = mem_to_add.range;
                        group.members.push(param);
                    }
                    console.log(group);
                    GroupGrid.update_pg(group);
                }
            }, "button_group_commit_changes");


            //ADDS THE SELECTED PARAMETER FROM THE GROUP VIEWER GRID TO THE WORKING FORMULA
            var button_add_selected_group_parameter_to_formula = new Button(
            {
                label: '&#8592 Add Parameter To Formula',
                onClick: function()
                {
                    //GET THE SELECTED GROUP FROM THE GROUP GRID
                    var selected_group = groupGrid.selection.getSelected();
                    if(selected_group.length != 1)
                        return alert("Select a group, then select one of the group's parameters to add to the current working formula.");

                    //GET THE FIRST ELEMENT OF THE SELECTION ARRAY
                    selected_group = selected_group[0];

                    //GET THE SELECTED PARAMETER FROM THE VIEWER GRID
                    var selected = selectionGrid.selection.getSelected();

                    //GET THE FIRST PARAMETER OF THE SELECTION ARRAY
                    selected = selected[0];

                    //IF THE VARIABLE TURNS OUT TO BE UNDEFINED, BAIL
                    if(!selected)
                        return alert('Select a Parameter from the Viewer Grid to Copy.');

                    //SEND THE PARAMETER AND GROUP NAME TO THE FUNCTION THAT WILL BUILD THE FORMULA VARIABLE STRING
                    var param_name = selected.name;
                    var group_name = selected_group.name;
                    add_param_to_formula(group_name, param_name);
                }
            }, "button_add_selected_group_parameter_to_formula");

            
            //RULES DIV FOR THE SLIDER
            var rulesNode = dojo.create("div", {}, dojo.byId("reportRangeSlider"), "first");

            //RULES DECLARATION. THESE ARE THE HASHES ONTOP OF THE SLIDER
            var sliderRules = new dijit.form.HorizontalRule(
            {
                container: "topDecoration",
                count: 4,
                style: "height: 8px",
            }, rulesNode);

            //LABELS DIV FOR THE SLIDER
            var labelsNode = dojo.create("div", {}, dojo.byId("reportRangeSlider"), "first");

            //BOTTOM NUMBERS FOR THE SLIDER.
            var sliderLabels = new dijit.form.HorizontalRuleLabels(
            {
                container: "bottomDecoration",
                count: 4,
                labels: [1,2,3,4],
                labelStyle: "font-style: italic; font-size: 1.0em",
            }, labelsNode);

            //THE SLIDER
            var reportRangeSlider = new dojox.form.HorizontalRangeSlider(
            {
                value: [1,4],
                minimum: 1,
                maximum: 4,
                discreteValues: 4,
                showButtons: false,
                onChange: function(value)
                {
                    dom.byId("reportRange").innerHTML = "Report Range: " + value;
                }
            },"reportRangeSlider");

            //RENDER THE SLIDER AND ITS RULERS
            reportRangeSlider.startup();
            sliderRules.startup();
            sliderLabels.startup();

            //DISPLAY THE VALUE OF THE SLIDER
            dom.byId("reportRange").innerHTML = "Report Range: " + reportRangeSlider.value;


            //ADDS THE SELECTED PARAMETER FROM THE WORKING GROUP MEMBERS GRID TO THE FORMULA WITH THE GIVEN GROUP NAME
            //CONSTRUCTS A FORMULA VARIABLE USING THE GROUP NAME AND PARAMETER NAME
            var add_param_to_formula = function(group_name, param_name) 
            {
                if(!param_name || !group_name)
                    return alert("There was an error adding the field to the formula.");
                if(dom.byId("txtBox_paramFormula").value == "")
                    dom.byId("txtBox_paramFormula").value = '${'+group_name+'.'+param_name+'}'; 
                else if(dom.byId("txtBox_paramFormula").value[dom.byId("txtBox_paramFormula").value.length-1] == ';')
                    dom.byId("txtBox_paramFormula").value += '${'+group_name+'.'+param_name+'}';
                else
                    dom.byId("txtBox_paramFormula").value += ';' + '${'+group_name+'.'+param_name+'}';   
            }


            //HELPER FUNCTION TO CHECK IF AN OBJECT POSSESSES ANY PROPERTIES
            function objectIsEmpty(map) 
            {
               for(var key in map) 
                  if (map.hasOwnProperty(key)) 
                     return false;

               return true;
            }

            //CLEAR TEXT FIELDS AND GRID SELECTIONS
            function ClearTextFields()
            {
                dom.byId('txtBox_groupName').value = '';
                membersStore.setData(new Array());
                membersGrid._refresh();
            }

            init();
        });
</script>
</head>

<!-- Layout -->
<body class="claro">
    <table width = '100%' border = "1">
        <col width = "50%">
        <col width = "14%">
        <col width = "36%">
        <tr> <!-- Labels -->
            <td style = "text-align: center; padding: 5px">
                <b>PG creator - Creates a New PG</b>
                <table width="100%">
                    <tr>
                        <td align="left" valign="bottom">
                            <div style="text-align: left"><button id="button_add_parameter_to_formula"></button></div>
                        </td>
                        <td valign="bottom">
                            <div style="text-align: right"><button id="button_add_to_selected_group"></button><button id = "button_newPG"></button></div>
                        </td>
                    </tr>
                </table>
                
            </td>
            <td style = "text-align: center; padding: 5px">
                <div style="vertical-align: top"><b>PG lister - Lists All PGs</b></div>
                <div style="text-align: right; vertical-align: bottom"><button id="button_clone_group"></button><button id="button_delete_group"></button>
                </div>
            </td>
            <td style = "text-align: center; vertical-align: top; padding: 5px">
                <b>PG Viewer - Shows Selected PG</b>
                <div style="text-align: right">
                    <button id="button_group_commit_changes"></button>
                    <button id="button_add_selected_group_parameter_to_formula"></button>
                    <button id="button_removeParameter"></button>
                </div>
            </td>
        </tr>
        <tr> <!-- Grids -->
            <td>
                <table width="100%">
                    <col width="40%">
                    <col width="60%">
                    <tr>
                        <td valign="top">
                            <table width='100%'>
                                <tr>
                                    <td>
                                        <table width="100%" style="padding: 3px; border:.1em solid black; background-color:#999999">
                                            <tr>
                                                <td>
                                                    <label for="txtBox_compParamName">Parameter Name:</label><br>  
                                                    <input id ='txtBox_compParamName' data-dojo-type="dijit/form/TextBox"></input>
                                                </td>
                                                <td valign="bottom">
                                                        <button id='button_add_pi_to_members'></button>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan='2'>
                                                    <label for="txtBox_paramFormula">Parameter Formula:</label><br>  
                                                    <input id ='txtBox_paramFormula' data-dojo-type="dijit/form/TextBox"> </input><br><br>
                                                </td>
                                            </tr>
                                            <tr>
                                                <td colspan='2'>
                                                    <div style = "padding: 2px" >
                                                        <div id="reportRange" style="font-size: 1em"></div>
                                                        <br>
                                                            <div align="center" id ="reportRangeSlider"></div>
                                                        <br>
                                                    </div>
                                                </td>           
                                            </tr>
                                            <tr>
                                                <td colspan='2'>
                                                    <div style = "padding: 2px; align: left">
                                                    <table id="operator" align="left" width="100%" style="padding: 3px; border:.1em solid black; background-color:#DDDDDD">
                                                        <tr>
                                                            <td colspan="100%" align="center">
                                                                <b>Operators</b>
                                                            </td>
                                                        </tr>
                                                        <tr>
                                                            <td>
                                                                <div style="text-align: center">
                                                                    <button id="button_multiplication"></button>
                                                                    <button id="button_division"></button>
                                                                    <button id="button_addition"></button>
                                                                    <button id="button_subtraction"></button>
                                                                </div>
                                                            </td>
                                                        </tr>
                                                    </table>
                                                    </div>
                                                    <br><br>
                                                </td>
                                            </tr>
                                        </table>
                                    </td>
                                </tr>
                                <tr>
                                    <td valign="top">
                                        <!-- <div style="padding: 2px" align='center'><b>Parameter Classes</b></div>
                                        <div id="ParamGrid"></div>
                                        <div align="right"><button id="button_delete_param_class"></button></div>  -->
                                        <!-- <br>
                                        <div style = "padding: 2px">
                                            <label for="txtBox_paramName">Add New Parameter:</label>
                                            <br> 
                                            <input id ='txtBox_paramName' data-dojo-type="dijit/form/TextBox"></input>
                                            <button id="button_commit_new_pi"></button>
                                            <br>
                                        </div>  -->
                                    </td>
                                </tr>
                            </table>
                        </td>
                        <td valign = "top">
                            <table width='100%'>
                                <tr>
                                    <td width="45%" align="right" valign = "bottom" style = "padding-top: 50px">
                                    </td>
                                    <td width="55%" valign="top">
                                        <div align="right" style = "padding: 2px">
                                            <label for="txtBox_groupName">Group Name:</label><br>  
                                            <input id="txtBox_groupName" data-dojo-type="dijit/form/TextBox"></input><br>
                                        </div>
                                    </td>
                                </tr>
                                <tr>
                                <td colspan = '3'>
                                    <table width="100%">
                                                    <col width="60%">
                                                    <col width="40%">
                                                    <tr>
                                                        <td align="right">
                                                            <div style="padding: 2px"><b>Working Members</b></div>
                                                        </td>
                                                        <td align="right">
                                                            <button id="button_removeWorkingMember"></button>
                                                        </td>
                                                    </tr>
                                                    <tr>
                                                        <td colspan = '2'>
                                                            <div id="membersGrid"></div>
                                                        </td>
                                                    </tr>
                                                </table>
                                    <!-- <table width="100%">
                                        <col width="6%">
                                        <col width="94%">
                                        <tr>
                                            <td>
                                                
                                            </td>
                                        </tr>
                                    </table> -->
                                </td>
                                </tr>
                            </tr>
                            </table>
                        </td>
                    </tr>
                </table>
            </td>
            <td valign = "top" style = "padding: 5px; text-align:right">
                <div id="GroupGridDiv"></div>
            </td>
            <td valign ="top" style = "padding: 5px">
                <div id="selectionGrid"></div>
            </td>
        </tr>
        <tr>
            <td colspan = '100%' style = "padding: 10px">
                <div id="serverResponse">Awaiting Action...</div>
            </td>
        </tr>
    </table>
</body>
</html>