<!DOCTYPE html>
<!-- This code was written by Alex Stout for Goal Zero, LLC private use -->
<html lang='en' style= 'background-color:#00FFFF; padding: 0px 25px 25px'>
<head>
    <title>Specs: Group Builder</title>
    <h1 ALIGN = 'center' style = 'padding: 10px'> Parameter: Group </h1>


    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/resources/dojo.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css">
        
    <!-- <link rel="stylesheet" href="../../_static/js/dojo/../dijit/themes/claro/claro.css"> -->
    <style type="text/css">@import "http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css";
        #parameterGridDiv 
        {
            height: 46em;
            width: 100%;
        }
        #selectionGrid 
        {
            height: 50em;
            width: 100%;
        }
        #groupGrid 
        {
            height: 50em;
            width: 100%;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js" data-dojo-config="async: true, isDebug: true">
    </script>

    <!-- Dojo Execution -->
    <script>
    require(['dojo/_base/lang', 
        'dojox/grid/DataGrid' , 
        'dojo/data/ItemFileWriteStore',
        "dojo/_base/array",
        'dijit/registry',
        'dojo/_base/xhr', 
        'dojox/grid/_CheckBoxSelector',
        'dijit/form/Select',
        "dijit/form/Button", 
        'dojo/dom' , 
        'dojo/domReady!'],
      function(lang, DataGrid, ItemFileWriteStore, baseArray, registry, xhr, _CheckBoxSelector, Select, Button, dom)
        {
            var fields = new Array();
            var has_loaded = false;

            /********************************     Group Grid      *********************************/


            var GroupGrid = new Object();

            GroupGrid._data = new Object();
            //Build the Dojo Grid for groups
            GroupGrid.buildGroupGrid = function(groups)
            {
                GroupGrid.selectedGroup;
                //Grid Data
                var data = 
                {
                  identifier: "id",
                  items: []
                };

                var data_list = []; // data list to display data

                //set data list values from fields parameter
                for(i=0;i<groups.length;i++)
                {
                    dijit.registry.remove('delt'+i);
                    data_list[i] = 
                    {
                        col1: 'id', 
                        col2: groups[i].group_name,
                        col3: new Button({label: 'Delete', id: 'delt'+i, onClick: function()
                            {
                                GroupGrid.deleteRow(this.id);
                            }
                        })
                    }
                }

                var rows = data_list.length; //# of rows = # of data
                for(var i = 0; i < rows; i++)
                {
                  data.items.push(lang.mixin({ id: i }, data_list[i]));
                }
                var groupStore = new ItemFileWriteStore({data: data}); //set up the store

                /*set up layout*/
                var layout = [[
                  {'name': '#', 'field': 'id', 'width': '5%'},
                  {'name': 'Group', 'field': 'col2', 'width': '80%'},
                  {'name': 'Delete', 'field': 'col3', 'width': '15%'}
                ]];

                //Remove the group grid if it already exists
                dijit.registry.remove("groupGrid");

                /*create a new grid*/
                var groupGrid = new DataGrid({
                    store: groupStore,
                    structure: layout,
                    autoHeigth: true}, "groupGrid");


                /*Call startup() to render the grid*/
                groupGrid.startup();

                //store the currently selected group.
                function noteSelected()
                {
                    var items = this.selection.getSelected();
                    GroupGrid._data = items[0].col2;
                    GroupGrid.selectedGroup = items[0].col2;
                }

                //When the group selection changes, update the SelectedGrid
                //and store which group is currently selected.
                groupGrid.on("SelectionChanged",
                        lang.hitch(groupGrid, GroupGrid.getFieldsOfSelectedGroup, true));
                groupGrid.on("SelectionChanged",
                        lang.hitch(groupGrid, noteSelected, true));

            }

            //Gets all the data that makes up the row at the index given by id
            GroupGrid.getGridItemById = function(id)
            {
                var gridItem = null;
                var grid = dijit.registry.byId('groupGrid');
                grid.store.fetchItemByIdentity({
                    identity: id,
                    onItem: function(item, request)
                    { 
                        gridItem=item; 
                    }
                });
                return gridItem;
            }

            //deletes the from the db and updates the grid
            GroupGrid.deleteRow = function(id)
            {
                var sub = id.substring(4, id.length);
                item = GroupGrid.getGridItemById(sub);
                if(!item){ return alert('error deleting '+sub+' from GroupGrid'); }
                if(!confirm("Are you sure you want to delete \'" + item.col2 +"\'?"))
                    return;
                else
                {
                    xhr.get(
                        {
                            url:"/group",
                            content: 
                            {
                                action: 'removeGroup',
                                group_name: item.col2,
                                loaded: has_loaded=true,
                            },
                            load:function(response)
                            {
                                dom.byId("serverResponse").innerHTML = "Response from server: " + response;
                            },
                            error:function(error)
                            {
                                console.log("There was an error: \n"+error);
                                dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                            }
                        });
                    GroupGrid.getGroups(); //refresh the contents of the table
                }
            }

            //Getter for the currently selected group
            GroupGrid.getSelected = function()
            {
                return GroupGrid._data[0];
            }

            //get the fields of the selected group from the database.
            GroupGrid.getFieldsOfSelectedGroup = function()
            {
                //get the selected items from the parameter grid
                var selectedGroup = GroupGrid.getSelected();
                if(!selectedGroup)
                    return;

                xhr.get(
                {
                    url:'/group',
                    handleAs: 'json', //grabs the xhr string and turns it into an object
                    content:
                    {
                        action: 'getFieldsOfSelectedGroup',
                        group_name: selectedGroup,
                        loaded: has_loaded = true,
                    },
                    load:function(response)
                    {
                        fieldsOfGroup = response;
                        // GroupGrid.buildGroupGrid(this.groups); //rebuild the dojo Grid
                        SelectionGrid.buildSelectionGrid(fieldsOfGroup);
                    },
                    error:function(error)
                    {
                        console.log("There was an error: " + error);
                        dom.byId("serverResponse").innerHTML = 'Response: ' + error;
                    }
                });
            }

            //Gets all the groups from the db
            GroupGrid.getGroups = function()
            {
                xhr.get(
                {
                    url:'/group',
                    handleAs: 'json', //grabs the xhr string and turns it into an object
                    content:
                    {
                        action: 'getGroups',
                        loaded: has_loaded = true,
                    },
                    load:function(response)
                    {
                        this.groups = response;
                        GroupGrid.buildGroupGrid(this.groups); //rebuild the dojo Grid
                        return this.groups;
                    },
                    error:function(error)
                    {
                        console.log("There was an error: " + error);
                        dom.byId("serverResponse").innerHTML = 'Response: ' + error;
                    }
                });
            }


            /********************************     Parameter Grid      *********************************/

            //The ParameterGrid is the grid that displays all the available fields from the database.
            var ParameterGrid = new Object();

            //Return the set of selected fields
            ParameterGrid.getSelected = function()
            {
                return this.selected_fields;
            }

            //Get the parameters from the db
            ParameterGrid.getFields = function()
            {
                xhr.get(
                {
                    url:'/group',
                    handleAs: 'json', //grabs the xhr string and turns it into an object
                    content:
                    {
                        action: 'getFields',
                        loaded: has_loaded = true,
                    },
                    load:function(response)
                    {
                        fields = response;
                        ParameterGrid.buildParameterGrid(fields); //rebuild the dojo Grid
                    },
                    error:function(error)
                    {
                        console.log("There was an error: " + error);
                        dom.byId("serverResponse").innerHTML = 'Response: ' + error;
                    }
                });
            }

            //Build the Dojo Grid with the 
            ParameterGrid.buildParameterGrid = function(fields)
            {
                ParameterGrid.selected_fields;

                if(fields.length < 1)
                    dom.byId('parameterGridDiv').innerHTML = '<b>There are no Parameters available</b>';
                else
                {
                    //Grid Data
                    var data = 
                    {
                      identifier: "id",
                      items: []
                    };

                    var data_list = []; // data list to display data

                    //set data list values from fields parameter
                    for(i=0;i<fields.length;i++)
                    {
                      data_list[i] = {col1: 'id', col2: fields[i].field_name}
                    }

                    var rows = data_list.length; //# of rows = # of data
                    for(var i = 0; i < rows; i++)
                    {
                      data.items.push(lang.mixin({ id: i }, data_list[i]));
                    }
                    var parameterStore = new ItemFileWriteStore({data: data}); //set up the store

                    /*set up layout*/
                    var layout = [{type: 'dojox.grid._CheckBoxSelector'},[
                      {'name': '#', 'field': 'id', 'width': '10%'},
                      {'name': 'Parameters', 'field': 'col2', 'width': '80%'},
                    ]];

                    dijit.registry.remove("parameterGridDiv");

                    /*create a new grid*/
                    var grid = new DataGrid({
                        store: parameterStore,
                        structure: layout,
                        autoHeigth: true}, 'parameterGridDiv');


                    /*Call startup() to render the grid*/
                    grid.startup();

                    //This function reports what fields are selected for the current working group
                    function reportSelection(node)
                        {
                            var items = this.selection.getSelected();
                            ParameterGrid.selected_fields = baseArray.map(items, function(item)
                            {
                                return item.col2;
                            }, this);
                            if(ParameterGrid.selected_fields.length > 0)
                            {
                                var msg = "You have selected " + ((ParameterGrid.selected_fields.length > 1) ? " ": " ");
                            }
                            else
                                var msg = "Nothing Selected";
                            node.innerHTML = msg + ParameterGrid.selected_fields.join(", ");
                        }

                    

                    // Event for when the selections are changed, call reportselection on the dom id given
                    // hitch() returns a function that will execute a given function in a given context. This function allows you 
                    // to control how a function executes, particularly in asynchronous operations
                    grid.on("SelectionChanged",
                        lang.hitch(grid, reportSelection, dom.byId("serverResponse")), true);
                    
                }    
            }

            /********************************     Selection Grid      *********************************/

            //Selection Grid contains a function to build a fresh version of itself
            //and a getter for the the selected items from the parameter grid
            var SelectionGrid = new Object();
            
            //Builds the grid of selected parameters for the working group
            SelectionGrid.buildSelectionGrid = function(selectedArray)
            {
                var data = 
                {
                  identifier: "id",
                  items: []
                };
                var data_list = [];
                for(i=0;i<selectedArray.length;i++)
                {
                  data_list[i] = {col1: 'id', col2: selectedArray[i]}
                }
                var rows = data_list.length;
                for(var i = 0; i < rows; i++)
                {
                  data.items.push(lang.mixin({ id: i }, data_list[i]));
                }
                var selectionStore = new ItemFileWriteStore({data: data});

                /*set up layout*/
                var layout = [[
                  {'name': '#', 'field': 'id', 'width': '15%'},
                  {'name': 'Parameters', 'field': 'col2', 'width': '85%'},
                ]];

                //remove the old selectionGrid from the dom
                dijit.registry.remove("selectionGrid");

                /*create a new grid*/
                var selectionGrid = new DataGrid({
                    store: selectionStore,
                    structure: layout,
                    autoHeigth: true}, "selectionGrid");

                /*Call startup() to render the grid*/
                selectionGrid.startup();
            }

            //Group Name Textbox
            var txtBox_groupName = registry.byId("txtBox_groupName");

            var select_groupType = new Select({
                options:
                [
                    {label: "Product Group", value: "product"},
                    {label: "View Group", value: "view"}
                ]}, "select_groupType");

            //Confirm selection button for new group
            //require a name for the group
            var button_confirmSelection = new Button(
            {
                label: 'Confirm',
                onClick: function()
                {
                    var selected_fields = ParameterGrid.getSelected();
                    if(!selected_fields)
                    {
                        dom.byId('serverResponse').innerHTML = 'You are required to select at least one parameter to form a group';
                    }
                    else if(dom.byId('txtBox_groupName').value == '')
                        dom.byId('serverResponse').innerHTML = 'You are required to provide a name for the new group';
                    else
                    {
                        xhr.get(
                        {
                            url:"/group",
                            content: 
                            {
                                action: 'newGroup',
                                group_name: dom.byId('txtBox_groupName').value,
                                group_fields: selected_fields,
                                loaded: has_loaded=true,
                            },
                            load:function(response)
                            {
                                dom.byId("serverResponse").innerHTML = "Response from server: " + response;
                                GroupGrid.getGroups();
                                ParameterGrid.getFields();
                                dom.byId('txtBox_groupName').value = '';
                            },
                            error:function(error)
                            {
                                console.log("There was an error: \n"+error);
                                dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                            }
                        });
                    }
                }
            }, "button_confirmSelection");  

        /* On load events */
        //Build an empty grid of selected items on load
        SelectionGrid.buildSelectionGrid(new Array());
        //Get the parameters and groups from the db
        ParameterGrid.getFields();
        // GroupGrid.buildGroupGrid(new Array());
        GroupGrid.getGroups();
        });
</script>
</head>

<!-- Layout -->
<body class="claro">
    <table width = '100%' border = "1">
        <col width = "33%">
        <col width = "34%">
        <col width = "33%">
        <tr> <!-- Labels -->
            <td style = "text-align: center">
                <p><b>Create New</b></p>
            </td>
            <td style = "text-align: center">
                <b>Group List</b>
            </td>
            <td style = "text-align: center">
                <p><b>Group Viewer</b></p>
            </td>
        </tr>
        <tr> <!-- Grids -->
            <td valign = "top" style = "padding: 5px">
                <label for="select_groupType" style = "padding: 5px">New Group Type:</label>
                <label for="txtBox_groupName" style = "padding: 5px">New Group Name:</label><br>  
                <div id="select_groupType" style ="width: 50%;"></div>
                <input id="txtBox_groupName" data-dojo-type="dijit/form/TextBox" style ="width: 50%;"></input>
                <div id= "button_confirmSelection" data-dojo-type="dijit/form/button"></div>
                <br><br>
                <div id="parameterGridDiv"></div>
            </td>
            <td valign = "top" style = "padding: 5px; text-align:right">
                <div id="groupGrid"></div>
            </td>
            <td valign ="top" style = "padding: 5px">
                <div id= "selectionGrid"></div>
            </td>
        </tr>
        <tr>
            <td colspan = "100%" style = "padding: 10px">
                <div id="serverResponse">Nothing Selected</div>
            </td>
        </tr>
    </table>
</body>
</html>