<!DOCTYPE html>
<!-- This code was written by Alex Stout for Goal Zero, LLC private use -->
<html lang='en' style= 'background-color:#00FFFF; padding: 0px 25px 25px'>
<head>
    <title>Specs: Product Builder</title>
    <h1 ALIGN = 'center' style = 'padding: 10px'> Parameter: Family </h1>

    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/resources/dojo.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css">
        
    <!-- <link rel="stylesheet" href="../../_static/js/dojo/../dijit/themes/claro/claro.css"> -->
    <style type="text/css">@import "http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css";
        #productGrid
        {
            height: 51em;
            width: 100%;
        }
        #selectionGrid 
        {
            height: 42em;
            width: 100%;
        }
        #groupGrid 
        {
            height: 42em;
            width: 100%;
        }
        #productSummaryGrid
        {
            height: 51em;
            width: 100%;
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js" data-dojo-config="async: true, isDebug: true">
    </script>

    <!-- Dojo Execution -->
    <script>
    require(['dojo/_base/lang', 
        'dojox/grid/DataGrid' , 
        'dojo/data/ItemFileWriteStore' ,
        "dojo/_base/array",
        'dijit/registry',
        'dojo/_base/xhr', 
        'dijit/form/RadioButton',
        'dojox/grid/_CheckBoxSelector',
        "dijit/form/Button", 
        'dijit/form/Select',
        'dojo/dom' , 
        'dojo/domReady!'],
      function(lang, DataGrid, ItemFileWriteStore, baseArray, registry, xhr, RadioButton, _CheckBoxSelector, Button, Select, dom)
        {

            var has_loaded = false;

            var GroupGrid = new Object();
            //Build the Dojo Grid for groups
            GroupGrid.buildGroupGrid = function(groups)
            {
                GroupGrid.selectedGroups;
                GroupGrid.dataOfSelection = new Array();
                GroupGrid.SelectionArray = new Array();

                //Grid Data
                var data = 
                {
                  identifier: "id",
                  items: []
                };

                var data_list = []; // data list to display data

                //set data list values from fields parameter
                for(i=0;i<groups.length;i++)
                {
                  data_list[i] = {
                    col1: 'id', 
                    col2: groups[i].pg_name,
                    col3: groups[i].pg_type,
                    }
                }

                var rows = data_list.length; //# of rows = # of data
                for(var i = 0; i < rows; i++)
                {
                  data.items.push(lang.mixin({ id: i }, data_list[i]));
                }
                var groupStore = new ItemFileWriteStore({data: data}); //set up the store

                /*set up layout*/
                var layout = [{type: 'dojox.grid._CheckBoxSelector'},[
                  {'name': '#', 'field': 'id', 'width': '10%'},
                  {'name': 'Group', 'field': 'col2', 'width': '65%'},
                  {'name': 'Type', 'field': 'col3', 'width': '25%'}
                ]];

                //Remove the group grid if it already exists
                dijit.registry.remove("groupGrid");

                /*create a new grid*/
                var groupGrid = new DataGrid({
                    store: groupStore,
                    structure: layout,
                    autoHeigth: true}, "groupGrid");


                /*Call startup() to render the grid*/
                groupGrid.startup();

                //store the currently selected group.
                function noteSelected(node)
                {
                    var items = this.selection.getSelected();
                    GroupGrid.selectedGroups = baseArray.map(items, function(item)
                    {
                        return item.col2;
                    }, this);
                    if(GroupGrid.selectedGroups.length > 0)
                    {
                        var msg = "You have selected " + ((GroupGrid.selectedGroups.length > 1) ? " ": " ");
                    }
                    else
                        var msg = "Nothing Selected";
                    node.innerHTML = msg + GroupGrid.selectedGroups.join(", ");
                }

                //When the group selection changes, update the SelectedGrid
                //and store which group is currently selected.
                groupGrid.on("SelectionChanged",
                        lang.hitch(groupGrid, noteSelected, dom.byId("serverResponse")), true);
                groupGrid.on("SelectionChanged",
                        lang.hitch(groupGrid, GroupGrid.getFieldsOfSelectedGroup, true));
            }

            //Getter for the currently selected group
            GroupGrid.getSelected = function()
            {
                return this.selectedGroups;
            }

            GroupGrid.getSelectedData = function()
            {
                return this.dataOfSelection;
            }

            //get the fields of the selected group from the database.
            GroupGrid.getFieldsOfSelectedGroup = function()
            {
                //store the selected group
                var selectedGroups = GroupGrid.selectedGroups;

                //Clear the selection array before retrieving the new set of data.
                GroupGrid.SelectionArray = new Array();
                var group_name;
                var fields = new Array();

                if(selectedGroups.length > 0)
                {
                    for(i=0;i<selectedGroups.length;i++)
                    {
                        xhr.get(
                        {
                            url:'/productBuilder',
                            handleAs: 'json', //grabs the xhr string and turns it into an object
                            content:
                            {
                                action: 'getFieldsOfSelectedGroup',
                                group_name: selectedGroups[i],
                                loaded: has_loaded = true,
                            },
                            load:function(response)
                            {
                                //pass the retrieved group_name and fields to the array builder.
                                group_name = response[0].pg_name;
                                fields = response[0].fields;
                                GroupGrid.buildSelectionArray(group_name, fields);
                            },
                            error:function(error)
                            {
                                console.log("There was an error: " + error);
                                dom.byId("serverResponse").innerHTML = 'Response: ' + error;
                            }
                        });
                    }
                }
                else // build the empty grid
                    SelectionGrid.buildSelectionGrid(new Array());
            }

            //This builds the array for the selection grid.
            GroupGrid.buildSelectionArray = function(group_name, fields)
            {
                //create a set that pairs each parameter with it's parent group.
                //and add each set to the array
                for(i=0;i<fields.length;i++)
                {
                    var set = new Object();
                    set.group_name = group_name;
                    set.field_name = fields[i].field_name;
                    set.field_value = fields[i].field_value;
                    set.field_unit = fields[i].field_unit;
                    GroupGrid.SelectionArray.push(set);
                }
                //Build the SelectionGrid
                SelectionGrid.buildSelectionGrid(GroupGrid.SelectionArray);
            }

            //Retrieve the groups from the db
            GroupGrid.getGroups = function()
            {
                xhr.get(
                {
                    url:'/group',
                    handleAs: 'json', //grabs the xhr string and turns it into an object
                    content:
                    {
                        action: 'getGroups',
                        loaded: has_loaded = true,
                    },
                    load:function(response)
                    {
                        this.groups = response;
                        GroupGrid.buildGroupGrid(this.groups); //rebuild the dojo Grid
                        return this.groups;
                    },
                    error:function(error)
                    {
                        console.log("There was an error: " + error);
                        dom.byId("serverResponse").innerHTML = 'Response: ' + error;
                    }
                });
            }

            /********************************     Selection Grid      *********************************/

            //Selection Grid contains a function to build a fresh version of itself
            //and a getter for the the selected items from the parameter grid
            var SelectionGrid = new Object();
            
            //Builds the grid of selected parameters for the working group
            // SelectionGrid.buildSelectionGrid = function(selectedArray)
            SelectionGrid.buildSelectionGrid = function(retrieved_data)
            {
                var data = 
                {
                  identifier: "id",
                  items: []
                };
                var data_list = [];
                for(i=0;i<retrieved_data.length;i++)
                {
                  data_list[i] = {
                    col1: 'id', 
                    col2: retrieved_data[i].group_name, 
                    col3: retrieved_data[i].field_name,
                    col4: retrieved_data[i].field_value,
                    col5: retrieved_data[i].field_unit
                    }
                }
                var rows = data_list.length;
                for(var i = 0; i < rows; i++)
                {
                  data.items.push(lang.mixin({ id: i }, data_list[i]));
                }
                var selectionStore = new ItemFileWriteStore({data: data});

                /*set up layout*/
                var layout = [[
                  {'name': '#', 'field': 'id', 'width': '10%'},
                  {'name': 'Group', 'field': 'col2', 'width': '30%'},
                  {'name': 'Parameter', 'field': 'col3', 'width': '30%'},
                  {'name': 'Value', 'field': 'col4', 'width': '15%'},
                  {'name': 'Unit', 'field': 'col5', 'width': '15%'},
                ]];

                //remove the old selectionGrid from the dom
                dijit.registry.remove("selectionGrid");

                /*create a new grid*/
                var selectionGrid = new DataGrid({
                    store: selectionStore,
                    structure: layout,
                    autoHeigth: true}, "selectionGrid");

                /*Call startup() to render the grid*/
                selectionGrid.startup();
            }


            /****************************   Begin Product Grid  *********************************/

            var ProductGrid = new Object();
            //Build the Dojo Grid for groups
            ProductGrid.buildProductGrid = function(products)
            {
                console.log(products);
                ProductGrid.selectedProduct;
                ProductGrid.selectedProductType;
                //Grid Data
                var data = 
                {
                  identifier: "id",
                  items: []
                };

                var data_list = []; // data list to display data

                //set data list values from fields parameter
                for(i=0;i<products.length;i++)
                {
                    dijit.registry.remove('delt'+i);
                    data_list[i] = 
                    {
                        col1: 'id', 
                        col2: products[i].pf_name,
                        col3: products[i].pf_type.substring(0,1),
                        col4: new Button({label: 'Delete', id: 'delt'+i, onClick: function()
                            {
                                ProductGrid.deleteRow(this.id);
                            }
                        })
                    } 
                }

                var rows = data_list.length; //# of rows = # of data
                for(var i = 0; i < rows; i++)
                {
                  data.items.push(lang.mixin({ id: i }, data_list[i]));
                }
                var productStore = new ItemFileWriteStore({data: data}); //set up the store

                /*set up layout*/
                var layout = [[
                  {'name': '#', 'field': 'id', 'width': '6%'},
                  {'name': 'Product', 'field': 'col2', 'width': '54%'},
                  {'name': 'Type', 'field': 'col3', 'width': '14%'},
                  {'name': 'Delete', 'field': 'col4', 'width': '24%'}
                ]];

                //Remove the group grid if it already exists
                dijit.registry.remove("productGrid");

                /*create a new grid*/
                var productGrid = new DataGrid({
                    store: productStore,
                    structure: layout,
                    autoHeigth: true}, "productGrid");


                /*Call startup() to render the grid*/
                productGrid.startup();

                //store the currently selected group.
                function noteSelected()
                {
                    var items = this.selection.getSelected();
                    ProductGrid.selectedProduct = items[0].col2;
                    ProductGrid.selectedProductType = items[0].col3;
                }

                // When the group selection changes, update the SelectedGrid
                // and store which group is currently selected.
                productGrid.on("SelectionChanged",
                        lang.hitch(productGrid, ProductGrid.getSpecs, true));
                productGrid.on("SelectionChanged",
                        lang.hitch(productGrid, noteSelected, true));

            }

            //Gets all the data that makes up the row at the index given by id
            ProductGrid.getGridItemById = function(id)
            {
                var gridItem = null;
                var grid = dijit.registry.byId('productGrid');
                grid.store.fetchItemByIdentity({
                    identity: id,
                    onItem: function(item, request)
                    { 
                        gridItem=item; 
                    }
                });
                return gridItem;
            }

            //deletes the from the db and updates the grid
            ProductGrid.deleteRow = function(id)
            {
                var sub = id.substring(4, id.length);
                item = ProductGrid.getGridItemById(sub);
                if(!item){ return alert('error deleting '+sub+' from productGrid'); }
                if(!confirm("Are you sure you want to delete \'" + item.col2 +"\'?"))
                    return;
                else
                {
                    xhr.get(
                        {
                            url:"/productBuilder",
                            content: 
                            {
                                action: 'removeFamily',
                                product_name: item.col2,
                                loaded: has_loaded=true,
                            },
                            load:function(response)
                            {
                                dom.byId("serverResponse").innerHTML = "Response from server: " + response;
                            },
                            error:function(error)
                            {
                                console.log("There was an error: \n"+error);
                                dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                            }
                        });
                    ProductGrid.getProducts(); //refresh the contents of the table
                }
            }

            //Getter for the currently selected Product
            ProductGrid.getSelected = function()
            {
                return this.selectedProduct;
            }

            //Getter for the currently selected Product type
            ProductGrid.getSelectedType = function()
            {
                return this.selectedProductType;
            }


            //get the fields of the selected group from the database.
            ProductGrid.getSpecs = function()
            {
                //get the selected items from the parameter grid
                var items = this.selection.getSelected();
                //store the selected group
                var selectedProduct = items[0].col2;
                var returnedProduct;

                xhr.get(
                {
                    url:'/productBuilder',
                    handleAs: 'json', //grabs the xhr string and turns it into an object
                    content:
                    {
                        action: 'getSpecs',
                        product_name: selectedProduct,
                        loaded: has_loaded = true,
                    },
                    load:function(response)
                    {
                        returnedProduct = response;
                        ProductSummaryGrid.buildGrid(returnedProduct);
                    },
                    error:function(error)
                    {
                        console.log("There was an error: " + error);
                        dom.byId("serverResponse").innerHTML = 'Response: ' + error;
                    }
                });
            }

            ProductGrid.getProducts = function()
            {
                xhr.get(
                {
                    url:'/productBuilder',
                    handleAs: 'json', //grabs the xhr string and turns it into an object
                    content:
                    {
                        action: 'getProducts',
                        loaded: has_loaded = true,
                    },
                    load:function(response)
                    {
                        this.products = response;
                        ProductGrid.buildProductGrid(this.products); //rebuild the dojo Grid
                    },
                    error:function(error)
                    {
                        console.log("There was an error: " + error);
                        dom.byId("serverResponse").innerHTML = 'Response: ' + error;
                    }
                });
            }

            /****************************   End Product Grid  *********************************/


            /****************************   Begin Product Summary Grid  *********************************/


            var ProductSummaryGrid = new Object();

            ProductSummaryGrid.buildGrid = function(returnedProduct)
            {
                ProductSummaryGrid.data;
                var productSpecs = new Array();

                if(returnedProduct.length > 0)
                {
                    productSpecs = returnedProduct[0].specs;
                }

                var data = 
                {
                  identifier: "id",
                  items: []
                };
                var data_list = [];
                for(i=0;i<productSpecs.length;i++)
                {
                  data_list[i] = {col1: 'id', 
                    col2: productSpecs[i].group_name, 
                    col3: productSpecs[i].field_name,
                    col4: productSpecs[i].field_value,
                    col5: productSpecs[i].field_unit
                    }
                }
                var rows = data_list.length;
                for(var i = 0; i < rows; i++)
                {
                  data.items.push(lang.mixin({ id: i }, data_list[i]));
                }
                var productSummaryStore = new ItemFileWriteStore({data: data});
                ProductSummaryGrid.data = data;

                /*set up layout*/
                var layout = [[
                  {'name': '#', 'field': 'id', 'width': '5%'},
                  {'name': 'Group', 'field': 'col2', 'width': '30%'},
                  {'name': 'Parameter', 'field': 'col3', 'width': '30%', 'editable': true},
                  {'name': 'Value', 'field': 'col4', 'width': '17%', 'editable': true},
                  {'name': 'Unit', 'field': 'col5', 'width': '18%', 'editable': true},
                ]];

                //remove the old selectionGrid from the dom
                dijit.registry.remove("productSummaryGrid");

                /*create a new grid*/
                var productSummaryGrid = new DataGrid({
                    store: productSummaryStore,
                    structure: layout,
                    autoHeigth: true}, "productSummaryGrid");

                /*Call startup() to render the grid*/
                productSummaryGrid.startup();

                productSummaryGrid.on("SelectionChanged",
                        lang.hitch(productSummaryGrid, ProductSummaryGrid.updateSpecs, true));
            }

            ProductSummaryGrid.updateSpecs = function()
            {
                console.log('Get Here?');
                items = this.selection.getSelected();
                console.log(items[0].col4);
            }

            ProductSummaryGrid.getData = function()
            {
                return this.data;

            }


            /****************************   TextBoxes / Button / Etc  *********************************/

            //Group Name Textbox
            var txtBox_productName = registry.byId("txtBox_productName");

            var radio_product= new RadioButton(
                {
                    checked: true,
                    value: "product",
                    name: "pf-type",
                    onChange: function()
                    {
                        if(this.checked == true)
                        {
                            //do something
                        }
                        else
                        {
                            //do something
                        }
                    }

                }, "radio_product");

            var radio_report = new RadioButton(
                {
                    checked: false,
                    value: "report",
                    name: "pf-type",
                    onChange: function()
                    {
                        if(this.checked == true)
                        {
                            //do something
                        }
                        else
                        {
                            //do something
                        }
                    }
                }, "radio_report");

            var select_familyType = new Select({
                options:
                [
                    {label: "Product Family", value: "product"},
                    {label: "View Family", value: "view"}
                ]}, "select_familyType");

            //Confirm selection button for new group
            //require a name for the group
            var button_confirmNewProduct = new Button(
            {
                label: 'Confirm',
                onClick: function()
                {
                    console.log("Selection size: " + GroupGrid.getSelected().length);
                    var selected = GroupGrid.SelectionArray;
                    selectedAsString = JSON.stringify(selected);
                    console.log('selectedAsString: ' + selectedAsString);
                    if(!selected)
                    {
                        dom.byId('serverResponse').innerHTML = 'You are required to select at least one group to form a product.';
                    }
                    else if(dom.byId('txtBox_productName').value == '')
                        dom.byId('serverResponse').innerHTML = 'You are required to provide a name for the new product.';
                    else
                    {
                        var pf_type = 'product';
                        if(radio_report.checked == true)
                            pf_type = 'report';
                        xhr.get(
                        {
                            url:"/productBuilder",
                            content: 
                            {
                                action: 'newProduct',
                                product_name: dom.byId('txtBox_productName').value,
                                pf_type: pf_type,
                                selected: selectedAsString,
                                loaded: has_loaded=true,
                            },
                            load:function(response)
                            {
                                dom.byId("serverResponse").innerHTML = "Response from server: " + response;
                                clearAll();
                            },
                            error:function(error)
                            {
                                console.log("There was an error: \n"+error);
                                dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                            }
                        });
                    }
                }
            }, "button_confirmNewProduct");

            //Confirm selection button for new group
            //require a name for the group
            var button_confirmUpdateSpecs = new Button(
            {
                label: 'Confirm Changes',
                onClick: function()
                {
                    var selectedProduct = ProductGrid.selectedProduct;
                    var selectedProductType = ProductGrid.selectedProductType;
                    //store the selected group
                    console.log('Selected Product: ' + selectedProduct);
                    var data = ProductSummaryGrid.getData();
                    var specs = new Array();
                    
                    console.log('data: ' + data.items[0].col4);
                    var i;
                    console.log('Amount of Data = ' + data.items.length);
                    for(i = 0; i<data.items.length;i++)
                    {
                        var spec = new Object();
                        spec.group_name = data.items[i].col2;
                        spec.field_name = data.items[i].col3;
                        spec.field_value = data.items[i].col4;
                        spec.field_unit = data.items[i].col5;
                        console.log('Spec: Group Name - ' + spec.group_name);
                        console.log('Spec: parameter - ' + spec.field_name);
                        console.log('Spec: parameter - ' + spec.field_value);
                        console.log('Spec: parameter - ' + spec.field_unit);    
                        
                        specs.push(spec);
                    }

                    var specString = JSON.stringify(specs);
                    
                    if(!selectedProduct)
                    {
                        dom.byId('serverResponse').innerHTML = 'You are required to select at least one group to form a product.';
                    }
                    else
                    {
                        xhr.get(
                        {
                            url:"/productBuilder",
                            content: 
                            {
                                action: 'updateSpecs',
                                product_name: selectedProduct,
                                product_type: selectedProductType,
                                specs: specString,
                                loaded: has_loaded=true,
                            },
                            load:function(response)
                            {
                                dom.byId("serverResponse").innerHTML = "Response from server: " + response;
                                clearAll();
                            },
                            error:function(error)
                            {
                                console.log("There was an error: \n"+error);
                                dom.byId("serverResponse").innerHTML = "Response from server: " + error;
                            }
                        });
                    }
                }
            }, "button_confirmUpdateSpecs");    


            function clearAll()
            {
                GroupGrid.getGroups();
                ProductGrid.getProducts();
                SelectionGrid.buildSelectionGrid(new Array());
                ProductSummaryGrid.buildGrid(new Array());
                dom.byId('txtBox_productName').value = '';
            }

            //On Load Functions    
            clearAll();
        });

    </script>
</head>

<!-- Layout -->
<body class="claro">
    <table width = '100%' border = "1">
        <col width = '47%'>
        <col width = '18%'>
        <col width = '35%'>
        <tr>
            <td style = "text-align: center; padding: 5px">
                <b>Create New</b>
                <div id= "button_confirmDiv" style = "text-align: right"><button id = "button_confirmNewProduct"></button></div>
            </td>
            <td style = "text-align: center; vertical-align: top; padding: 5px">
                <b>Family List</b>
            </td>
            <td style = "text-align: center; vertical-align: top; padding: 5px">
                <b>Family Viewer</b>
                <div style = "text-align: right"><button id = "button_confirmUpdateSpecs"></button></div>
            </td>
        </tr>
        <tr>
            <td valign = "top" style = "padding: 5px">
                <div style = "padding: 2px">
                <input id = "radio_product"><label for = "radio_product">Product</label></div>
                <div style = "padding: 2px">
                <input id = "radio_report"><label for = "radio_report">Report</label><br><br></div>
                <label for="txtBox_productName">Name:</label><br>
                <input id="txtBox_productName" data-dojo-type="dijit/form/TextBox" style ="width: 50%;"></input>
                <table width = '100%'>
                    <col width = '40%'>
                    <col width = '60%'>
                    <tr>
                        <td>
                            <div style = "padding: 10px">Groups<div>
                        </td>
                        <td>
                            <div style = "padding: 10px">Preview<div>
                        </td>
                    </tr>
                    <tr>
                        <td>
                            <div id="groupGrid"></div>
                        </td>
                        <td>
                            <div id= "selectionGrid"></div>
                        </td>
                    </tr>
                </table>
            </td>
            <td valign = "top" style = "padding: 5px; text-align:right">
                <div id="productGrid"></div>
            </td>
            <td valign = "top" style = "padding: 5px; text-align:right">
                <div id="productSummaryGrid"></div>
            </td>
        </tr>
        <tr>
            <td colspan = "100%" style = "padding: 10px">
                <div id="serverResponse">Awaiting Action...</div>
            </td>
        </tr>
    </table>
</body>
</html>





