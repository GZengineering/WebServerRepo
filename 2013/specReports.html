<!DOCTYPE html>
<!-- This code was written by Alex Stout for Goal Zero, LLC private use -->
<html lang='en' style= 'background-color:#00FFFF; padding: 20px 50px 50px'>
<head>
    <title>Specs: Product Spec Reports</title>


    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/resources/dojo.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css">
        
    <!-- <link rel="stylesheet" href="../../_static/js/dojo/../dijit/themes/claro/claro.css"> -->
    <style type="text/css">@import "http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css";
        #ProductSelect
        {
            min-width: 10em
        }

    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js" data-dojo-config="async: true, isDebug: true">
    </script>

    <!-- Dojo Execution -->
    <script>
    require(['dojo/_base/lang', 
        'dojox/grid/DataGrid' , 
        'dojo/data/ItemFileWriteStore' ,
        "dojo/_base/array",
        'dijit/registry',
        'dojo/_base/xhr', 
        'dijit/form/RadioButton',
        'dojox/grid/_CheckBoxSelector',
        "dijit/form/Button",
        'dijit/form/TextBox', 
        'dijit/form/Select', 
        'dojo/store/Observable',
        'dojo/store/Memory',
        'dojo/data/ObjectStore',
        'dojo/dom' , 
        'dojo/domReady!'],
      function(lang, DataGrid, ItemFileWriteStore, baseArray, registry, xhr, RadioButton, _CheckBoxSelector, Button, TextBox, Select, Observable, Memory, ObjectStore, dom)
        {

            init();



            /*  THIS FLAG NOTIFIES THE SERVER WHETHER THE HTML FOR THIS PAGE HAS ALREADY BEEN LOADED  */
            var has_loaded = false;

            /*  CREATE A DATA STORE TO CONTAIN ALL THE CONTENT OF THE SERVER  */
            var fullDbMemStore = new Memory({data: new Array()});
                fullDbMemStore = Observable(fullDbMemStore);
                var fullDataStore = new ObjectStore({
                    objectStore: fullDbMemStore
                });
            window.fullDbMemStore = fullDbMemStore; //MAKE IT GLOBAL

            /*  FUNCTION TO GET ALL THE DB DATA AND FILL THE DATA STORE  */
            /*  SUBSEQUENT FUNCTIONS WILL BE CALLED TO COMPLETE THE PROCESS  */
            init = function()
            {
                xhr.get(
                {
                    url:'/global',
                    handleAs: 'json',
                    content:
                    {
                        action: 'getAll',
                        loaded: has_loaded = true,
                    },
                    load: function(response)
                    {
                        fullDbMemStore.data = response;
                        BuildGrids();
                    },
                    error: function(error)
                    {
                        var msg = 'There was an error getting the db. Error: ' + error;
                        dom.byId("serverResponse").innerHTML = 'Response: ' + msg;
                        console.log(msg);
                    }
                });
            }

            /*  BUILDS THE GRIDS USING THE COLLECTED AND ORGANIZED DATA  */
            function BuildGrids()
            {
                //QUERY TO GET THE PARAMETERS FROM THE FULL STORE
                var families = fullDbMemStore.query({type: "pgf"});
                var familyStore = new Memory({data: families, idProperty: 'name'});
                    familyStore = Observable(familyStore);
                    var familyDataStore = new ObjectStore({
                        objectStore: familyStore
                    });

                //GLOBALIZE THE PARAMETER STORE
                window.familyStore = familyStore;
                window.familyDataStore = familyDataStore;

                //FILL THE DROP-DOWN OPTIONS
                fillOptions(families);
            }

            //DECLARE THE DROP-DOWN WITH AN EMPTY OPTIONS SET
            var ProductSelect = new Select(
            {
                options: [],
            }, "ProductSelect");

            //REGISTER THE SELECTION CHANGE EVENT OF THE DROP-DOWN TO BUILD THE NEW TABLE FOR THE SELECTED FAMILY
            dojo.connect(ProductSelect, "onChange", function(value)
            {
                var family = familyStore.get(value);
                buildTable(family);
            });

            //FILL THE DROP-DOWN WITH THE FAMILIES FROM THE DB
            var fillOptions = function(families)
            {
                for(var i = 0;i < families.length; i++)
                {
                    var p = families[i];
                    ProductSelect.options.push({label: p.name, value: p.name});
                }
                ProductSelect.set(ProductSelect.options[0]);
            }


            buildTable = function(family)
            {
                //CLEAR THE HTML 
                dom.byId("ReportGrid").innerHTML = '';

                var html_table = '';

                var table_properties = "\"cellspacing='0' cellpadding='0' border='0' style= \"border-collapse: collapse;table-layout:fixed;width:311pt\"";

                var header_style = "style=\"height:15.0pt;width:136pt; font-size:11.0pt;color:white;font-weight:700;text-decoration:none;text-underline-style: none;text-line-through:none;font-family:Cambria;border-top:1.0pt solid black; border-right:.5pt solid black;border-bottom:.5pt solid black;border-left: .5pt solid black;background:#404040;mso-pattern:black none; padding: 2px\"";


                var rowCount = 0;

                //TABLE HEADER
                html_table += "<table "+table_properties+">";
                html_table += "<tr><td colspan='2' "+header_style+"><b>Technical Specifications</b></tr>";

                //FAMILY NAME ROW
                html_table += "<tr>"; 
                html_table += "<td "+get_row_style('pgf',rowCount)+">";
                html_table += "Product:";
                html_table += "</td>";
                html_table += "<td align=right "+get_row_style('pgf',rowCount)+">";
                html_table += family.name;
                html_table += "</td>";
                html_table += "</tr>";
                rowCount++;


                //ENTER EACH GROUP AS A ROW AND EACH GROUPS PARAMETERS AS A ROW
                for(var i = 0; i < family.members.length; i++)
                {
                    //IF THE MEMBER IS NULL, BAIL
                    if(!family.members[i])
                        continue;

                    group = family.members[i];

                    //ADD ROW FOR CURRENT GROUP
                    html_table += "<tr>"; 
                    html_table += "<td "+get_row_style('pg',rowCount)+">";
                    html_table += group.name;
                    html_table += "</td>";
                    html_table += "<td align=right "+get_row_style('pg',rowCount)+"> ";
                    html_table += "</td>";
                    html_table += "</tr>";
                    rowCount++; //INCREMENT ROW COUNT

                    //FOR EACH PARAMETER OF THE GROUP, ADD A ROW
                    for(var j = 0; j<group.members.length; j++)
                    {
                        //IF THE MEMBER IS NULL, BAIL
                        if(!group.members[i])
                            continue;

                        var parameter = group.members[j];

                        var realized_value = realizeValue(group, parameter.members.value);

                        //ADD ROW FOR CURRENT PARAMETER
                        html_table += "<tr>"; 
                        html_table += "<td "+get_row_style('p',rowCount)+">";
                        html_table += parameter.name;
                        html_table += "</td>";
                        html_table += "<td align=right "+get_row_style('p',rowCount)+"> ";
                        html_table += realized_value;
                        html_table += "</td>";
                        html_table += "</tr>";
                        rowCount++; //INCREMENT ROW COUNT
                    }
                }

                //CLOSE THE TABLE AND SET THE DOM HTML TO THE HTML STRING
                html_table += "</table>";
                dom.byId("ReportGrid").innerHTML = html_table;
            }

            //DETERMINES THE STYLE OF A ROW FOR THE TABLE GIVEN THE NUMBER OF THE ROW AND THE TYPE OF DATA IT CONTAINS
            function get_row_style(type, rowCount)
            {
                //STYLE FOR A GROUP (OR FAMILY) ON ODD ROWS
                var odd_style_group = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:700;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black;background:#FFFFFF;mso-pattern:white none; padding: 2px\"";

                //STYLE FOR A GROUP (OR FAMILY) ON EVEN ROWS
                var even_style_group = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:700;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black; background:#D9D9D9;mso-pattern:#D9D9D9 none; padding: 2px\"";

                //STYLE FOR A PARAMETER ON ODD ROWS
                var odd_style_parameter = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:200;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black;background:#FFFFFF;mso-pattern:white none; padding: 2px\"";

                //STYLE FOR A PARAMETER ON EVEN ROWS
                var even_style_parameter = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:200;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black; background:#D9D9D9;mso-pattern:#D9D9D9 none; padding: 2px\"";

                //IF THE COUNT IS EVEN AND IT'S A GROUP OR A FAMILY, DO EVEN_STYLE_GROUP
                if(rowCount%2 == 0 && (type == 'pg' || type == 'pgf'))
                    return even_style_group;
                //IF THE COUNT IS EVEN AND IT'S A PARAMETER, DO EVEN_STYLE_PARAMETER
                else if(rowCount%2 == 0 && type == 'p')
                    return even_style_parameter;
                //IF THE COUNT IS ODD AND THE DATA IS GROUP OR FAMILY, DO ODD_STYLE_GROUP
                else if(rowCount%2 == 1 && (type == 'pg' || type == 'pgf'))
                    return odd_style_group;
                //IF THE COUNT IS ODD AND THE DATA IS A PARAMETER, DO ODD_STYLE_PARAMETER
                else if(rowCount%2 == 1 && type == 'p')
                    return odd_style_parameter;
            }

            //PARSE THE GIVEN DEFINITION STRING AND GROUP
            function realizeValue(group, value)
            {
                //SPLIT THE STRING BY ';' AND STORE THE ELEMENTS IN AN ARRAY
                var val_elements = value.split(";");

                //AN ARRAY TO MAKE UP THE PARSED ELEMENTS OF THE OUTPUT STRING
                var output_elements = [];

                //QUERY THE STORE FOR ALL PIs
                var pis = group.members;

                //STRING FOR FINAL OUTPUT
                var output = '';

                //IF THERE ARE NO PIs OR THE ARRAY IS NULL,
                //REPORT AN ERROR
                if(pis.length < 1 || pis == null)
                {
                    output = 'There was a problem acquiring the parameters';
                    console.log('Parse Error: ' + output);
                    return output;
                } 
                //WHILE ELEMENTS REMAIN
                while(val_elements.length > 0)
                {
                    //FLAG FOR WHEN AN ELEMENT IS MATCHED
                    var not_found = true;
                    //TEMP VARIABLE TO STORE A GRABBED PROPERTY
                    var temp_property;

                    //GET THE NEXT ELEMENT FROM THE ARRAY
                    var element = val_elements.shift();

                    //FIND THE ELEMENTS FROM THE GROUP AND MATCH THEM TO THE ELEMENTS
                    for(var i = 0; i < pis.length; i++)
                    {
                        if(!not_found) //IF ELEMENT HAS BEEN MATCHED, BREAK 
                            break;

                        //STORE CURRENT PARAMETER
                        var pi = pis[i];

                        //IF THE ELEMENT AND THE PARAMETER NAME MATCH, GET THE PARAMETERS VALUE
                        if(element == pi.name)
                        {
                            output_elements.push(pi.members.value);
                            not_found = false;
                        }
                    }
                    //IF THE ELEMENT WAS NEVER MATCHED, IT'S PROBABLY A STRING OR AN OPERATOR, ADD IT TO THE OUTPUT
                    if(not_found)
                        output_elements.push(element);

                }
                //IF THERE ARE NO MORE ELEMENTS BUILD THE STRING AND RETURN IT
                if(val_elements.length < 1)
                {
                    output = build_output_string(output_elements);
                    return output;
                }
                else //IF WE GET HERE AND HAVEN'T REPORTED THE STRING AND WE STILL HAVE ELEMENTS, THERE'S AN ERROR
                {
                    output = 'An unknown error occurred parsing the definition.';
                    return output;
                }
            }

            //BUILD THE OUTPUT STRING WITH THE GIVEN ARRAY OF STRINGS
            function build_output_string(output_elements)
            {
                var output_string = '';
                for (var i = 0; i < output_elements.length; i++)
                    output_string += output_elements[i];
                try
                {
                    output_string = eval(output_string);
                    output_string = output_string.toFixed(1); //ROUND TO 3 DECIMALS
                }
                catch(error)
                {
                    //if there's an error, ignore it and return the string as it was.
                }
                var i = output_string.indexOf('.0')
                if(i != -1)
                    output_string = output_string.slice(0,i);
                return output_string;
            }

            
        });

    </script>
</head>

<!-- Layout -->
<body class="claro">
    <table width = '100%' border = "1">
        <col width = '100%'>
        <tr>
            <td style = "text-align: center; padding: 5px">
                <b>Products:</b>
            </td>
        </tr>
        <tr>
            <td valign = "top" style = "padding: 5px; text-align:left">
                <div id="ProductSelect"></div>
                <div id = "ReportGrid"></div>
            </td>
        </tr>
        <tr>
            <td colspan = "100%" style = "padding: 10px">
                <div id="serverResponse">Nothing Selected</div>
            </td>
        </tr>
    </table>
</body>
</html>