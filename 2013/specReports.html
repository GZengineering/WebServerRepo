<!DOCTYPE html>
<!-- This code was written by Alex Stout for Goal Zero, LLC private use -->
<html lang='en' style= 'background-color:#666666; padding: 20px 50px 50px'>
<head>
    <title>Specs: Product Spec Reports</title>




    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/resources/dojo.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dijit/themes/claro/claro.css">
    <link rel="stylesheet" href="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css">
        
    <!-- <link rel="stylesheet" href="../../_static/js/dojo/../dijit/themes/claro/claro.css"> -->
    <style type="text/css">@import "http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojox/grid/resources/claroGrid.css";
        #ProductSelect
        {
            min-width: 10em
        }
        #GradeSelect
        {
            min-width: 10em
        }
    </style>
    <script src="http://ajax.googleapis.com/ajax/libs/dojo/1.8.3/dojo/dojo.js" data-dojo-config="async: true, isDebug: true">
    </script>

    <!-- Dojo Execution -->
    <script>
    require(['dojo/_base/lang', 
        'dojox/grid/DataGrid' , 
        'dojo/data/ItemFileWriteStore' ,
        "dojo/_base/array",
        'dijit/registry',
        'dojo/_base/xhr', 
        'dijit/form/RadioButton',
        'dojox/grid/_CheckBoxSelector',
        "dijit/form/Button",
        'dijit/form/TextBox', 
        'dijit/form/Select', 
        'dojo/store/Observable',
        'dojo/store/Memory',
        'dojo/data/ObjectStore',
        'dojo/dom' , 
        'dojo/domReady!'],
      function(lang, DataGrid, ItemFileWriteStore, baseArray, registry, xhr, RadioButton, _CheckBoxSelector, Button, TextBox, Select, Observable, Memory, ObjectStore, dom)
        {

            window.report_grade = 4;
            window.selected_family = {};

            /*  THIS FLAG NOTIFIES THE SERVER WHETHER THE HTML FOR THIS PAGE HAS ALREADY BEEN LOADED  */
            var has_loaded = false;

            /*  CREATE A DATA STORE TO CONTAIN ALL THE CONTENT OF THE SERVER  */
            var fullDbMemStore = new Memory({data: new Array()});
                fullDbMemStore = Observable(fullDbMemStore);
                var fullDataStore = new ObjectStore({
                    objectStore: fullDbMemStore
                });
            window.fullDbMemStore = fullDbMemStore; //MAKE IT GLOBAL

            /*  FUNCTION TO GET ALL THE DB DATA AND FILL THE DATA STORE  */
            /*  SUBSEQUENT FUNCTIONS WILL BE CALLED TO COMPLETE THE PROCESS  */
            init = function()
            {
                xhr.get(
                {
                    url:'/global',
                    handleAs: 'json',
                    content:
                    {
                        action: 'getAll',
                        loaded: has_loaded = true,
                    },
                    load: function(response)
                    {
                        fullDbMemStore.data = response;
                        BuildGrids();
                    },
                    error: function(error)
                    {
                        var msg = 'There was an error getting the db. Error: ' + error;
                        console.log(msg);
                        alert(msg);
                    }
                });
            }

            /*  BUILDS THE GRIDS USING THE COLLECTED AND ORGANIZED DATA  */
            function BuildGrids()
            {
                //QUERY TO GET THE PARAMETERS FROM THE FULL STORE
                var families = fullDbMemStore.query({type: "pgf"});
                var familyStore = new Memory({data: families, idProperty: 'name'});
                    familyStore = Observable(familyStore);
                    var familyDataStore = new ObjectStore({
                        objectStore: familyStore
                    });

                //GLOBALIZE THE PARAMETER STORE
                window.familyStore = familyStore;
                window.familyDataStore = familyDataStore;

                //FILL THE DROP-DOWN OPTIONS
                fillOptions(families);
            }

            //DECLARE THE DROP-DOWN WITH AN EMPTY OPTIONS SET
            var GradeSelect = new Select(
            {
                options: [],
            }, "GradeSelect");

            //REGISTER THE SELECTION CHANGE EVENT OF THE DROP-DOWN TO BUILD THE NEW TABLE FOR THE SELECTED FAMILY
            dojo.connect(GradeSelect, "onChange", function(value)
            {
                // selected_family = familyStore.get(value);
                report_grade = value;
                console.log(report_grade);
                console.log(selected_family);
                buildPGF(selected_family, report_grade);
                // buildTable(family, report_grade);
            });

            //DECLARE THE DROP-DOWN WITH AN EMPTY OPTIONS SET
            var ProductSelect = new Select(
            {
                options: [],
            }, "ProductSelect");

            //BUTTON THAT WILL GET THE LATEST DATA FROM THE DATABASE AND REPOPULATE THE GRIDS
            var button_refresh_data = new Button(
            {
                label: 'Refresh All Data',
                onClick: function()
                {
                    init();
                }
            }, "button_refresh_data");

            //REGISTER THE SELECTION CHANGE EVENT OF THE DROP-DOWN TO BUILD THE NEW TABLE FOR THE SELECTED FAMILY
            dojo.connect(ProductSelect, "onChange", function(value)
            {
                selected_family = familyStore.get(value);
                console.log(selected_family);
                buildPGF(selected_family, report_grade);
            });

            //FILL THE DROP-DOWN WITH THE FAMILIES FROM THE DB
            var fillOptions = function(families)
            {
                for(var i = 0;i < families.length; i++)
                {
                    var p = families[i];
                    ProductSelect.options.push({label: p.name, value: p.name});
                }
                ProductSelect.set('value', ProductSelect.options[0]);
                GradeSelect.options.push({label: "Light", value: 1});
                GradeSelect.options.push({label: "Medium", value: 2});
                GradeSelect.options.push({label: "Heavy", value: 3});
                GradeSelect.options.push({label: "Comprehensive", value: 4});
                GradeSelect.set('value', GradeSelect.options[3]);
                if(!families || families.length < 1)
                {
                    ProductSelect.options.push({label: "(Empty)", value: "(Empty)"});
                    ProductSelect.set('value', ProductSelect.options[0]);
                    buildTable("", report_grade);
                    return;
                }
                console.log(GradeSelect.get('value'));
            }

            //CONSTRUCTS A PGF OBJECT WITH THE GIVEN FAMILY DB REFERENCE AND A REPORT GRADE.
            //THE GRADE DETERMINES WHAT PARAMETERS ARE PUT INTO THE OBJECT FOR DISPLAY.
            buildPGF = function(family, grade)
            {
                console.log(family);
                var parameters = fullDbMemStore.query({type: "p"});
                var groups = fullDbMemStore.query({type: "pg"});
                console.log(parameters);
                console.log(groups);

                var rows = [];

                var pgf = {};
                pgf.name = family.name;
                pgf.type = family.type;
                pgf.members = [];

                pgs = family.members;

                for(var i = 0; i < pgs.length; i++)
                {
                    var pg = pgs[i];
                    var group = {};

                    for(var j = 0; j < groups.length; j++)
                    {
                        var g = groups[j];
                        console.log(pg);
                        console.log(g);
                        if(pg._id == g._id)
                        {
                            group = g;
                            break;
                        }
                    }

                    var pis = pg.members;
                    var params = [];

                    //DEFINE THE THE ROW FOR THE VIEWER GRID USING THE PI & PG DATA
                    for(var k = 0; k<pis.length; k++)
                    {
                        var matched = false;
                        var pi = pis[k];
                        if(!pi)
                            continue;

                        for(var l = 0; l < parameters.length; l++)
                        {
                            if(matched)
                                break;

                            var p = parameters[l];

                            if(p.members.report_range.x > grade || p.members.report_range.y < grade)
                                continue;

                            if(pi._id == p._id)
                            {
                                var param = {};
                                row = {};
                                row.pg_name = group.name;
                                row.p_name = p.name;
                                param.name = p.name;
                                param._id = p._id;
                                param.members = p.members;
                                row.p_value = pi.value;
                                param.value = pi.value;
                                param.type = p.type;
                                rows.push(row);
                                params.push(param);
                                matched = true;
                            }
                        }
                    }
                    var temp = {};
                    temp.name = group.name;
                    temp.type = group.type;
                    temp.members = params;
                    pgf.members.push(temp);
                }
                console.log(pgf);

                console.log(rows);

                buildTable(pgf, grade);
            }

            //BUILD THE HTML TABLE GIVEN THE PRE-CONSTRUCTED FAMILY OBJECT AND THE REPORT GRADE
            buildTable = function(family, grade)
            {
                //CLEAR THE HTML 
                dom.byId("ReportGrid").innerHTML = '';

                var html_table = '';

                var table_properties = "\"cellspacing='0' cellpadding='0' border='0' style= \"border-collapse: collapse;table-layout:fixed;width:400pt\"";

                var header_style = "style=\"height:15.0pt;width:136pt; font-size:11.0pt;color:white;font-weight:700;text-decoration:none;text-underline-style: none;text-line-through:none;font-family:Cambria;border-top:1.0pt solid black; border-right:.5pt solid black;border-bottom:.5pt solid black;border-left: .5pt solid black;background:#404040;mso-pattern:black none; padding: 2px\"";

                var report_grade_desc = "Light";
                if(grade == 2)
                    report_grade_desc = "Medium";
                else if(grade == 3)
                    report_grade_desc = "Heavy";
                else if(grade == 4)
                    report_grade_desc = "Comprehensive";


                var rowCount = 0;

                //TABLE HEADER
                html_table += "<table "+table_properties+">";
                html_table += "<tr><td "+header_style+"><b>Technical Specifications</b>";
                html_table += "<td align=right "+header_style+"><b>Report Level: "+report_grade_desc+"</b></tr>";

                if(!family.members)
                {
                    html_table += "<tr>";
                    html_table += "<td colspan = '2' "+get_row_style('pgf',rowCount)+">";
                    html_table += "NO PRODUCTS WERE RETRIEVED";
                    html_table += "</td>";
                    html_table += "</tr>";
                    //CLOSE THE TABLE AND SET THE DOM HTML TO THE HTML STRING
                    html_table += "</table>";
                    dom.byId("ReportGrid").innerHTML = html_table;
                    return;
                }

                //FAMILY NAME ROW
                html_table += "<tr>"; 
                html_table += "<td "+get_row_style('pgf',rowCount)+">";
                html_table += "Product:";
                html_table += "</td>";
                html_table += "<td align=right "+get_row_style('pgf',rowCount)+">";
                html_table += family.name;
                html_table += "</td>";
                html_table += "</tr>";
                rowCount++;

                

                //ENTER EACH GROUP AS A ROW AND EACH GROUPS PARAMETERS AS A ROW
                for(var i = 0; i < family.members.length; i++)
                {
                    //IF THE MEMBER IS NULL, BAIL
                    if(!family.members[i])
                        continue;

                    group = family.members[i];

                    if(group.members.length < 1)
                        continue;

                    //ADD ROW FOR CURRENT GROUP
                    html_table += "<tr>"; 
                    html_table += "<td "+get_row_style('pg',rowCount)+">";
                    html_table += group.name;
                    html_table += "</td>";
                    html_table += "<td align=right "+get_row_style('pg',rowCount)+"> ";
                    html_table += "</td>";
                    html_table += "</tr>";
                    rowCount++; //INCREMENT ROW COUNT

                    //FOR EACH PARAMETER OF THE GROUP, ADD A ROW
                    for(var j = 0; j<group.members.length; j++)
                    {
                        //IF THE MEMBER IS NULL, BAIL
                        if(!group.members)
                            continue;

                        var parameter = group.members[j];

                        console.log(group);
                        console.log(parameter);

                        // var realized_value = realizeValue(family, parameter.members.value);

                        //ADD ROW FOR CURRENT PARAMETER
                        html_table += "<tr>"; 
                        html_table += "<td "+get_row_style('p',rowCount)+">";
                        html_table += parameter.name;
                        html_table += "</td>";
                        html_table += "<td align=right "+get_row_style('p',rowCount)+"> ";
                        html_table += parameter.value;
                        html_table += "</td>";
                        html_table += "</tr>";
                        rowCount++; //INCREMENT ROW COUNT
                    }
                }

                //CLOSE THE TABLE AND SET THE DOM HTML TO THE HTML STRING
                html_table += "</table>";
                dom.byId("ReportGrid").innerHTML = html_table;
            }

            //DETERMINES THE STYLE OF A ROW FOR THE TABLE GIVEN THE NUMBER OF THE ROW AND THE TYPE OF DATA IT CONTAINS
            function get_row_style(type, rowCount)
            {
                //STYLE FOR A GROUP (OR FAMILY) ON ODD ROWS
                var odd_style_group = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:700;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black;background:#FFFFFF;mso-pattern:white none; padding: 2px\"";

                //STYLE FOR A GROUP (OR FAMILY) ON EVEN ROWS
                var even_style_group = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:700;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black; background:#D9D9D9;mso-pattern:#D9D9D9 none; padding: 2px\"";

                //STYLE FOR A PARAMETER ON ODD ROWS
                var odd_style_parameter = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:200;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black;background:#FFFFFF;mso-pattern:white none; padding: 2px\"";

                //STYLE FOR A PARAMETER ON EVEN ROWS
                var even_style_parameter = "style=\"height:15.0pt;font-size:11.0pt; color:black;font-weight:200;text-decoration:none;text-underline-style:none; text-line-through:none;font-family:Calibri;border:.5pt solid black; background:#D9D9D9;mso-pattern:#D9D9D9 none; padding: 2px\"";

                //IF THE COUNT IS EVEN AND IT'S A GROUP OR A FAMILY, DO EVEN_STYLE_GROUP
                if(rowCount%2 == 0 && (type == 'pg' || type == 'pgf'))
                    return even_style_group;
                //IF THE COUNT IS EVEN AND IT'S A PARAMETER, DO EVEN_STYLE_PARAMETER
                else if(rowCount%2 == 0 && type == 'p')
                    return even_style_parameter;
                //IF THE COUNT IS ODD AND THE DATA IS GROUP OR FAMILY, DO ODD_STYLE_GROUP
                else if(rowCount%2 == 1 && (type == 'pg' || type == 'pgf'))
                    return odd_style_group;
                //IF THE COUNT IS ODD AND THE DATA IS A PARAMETER, DO ODD_STYLE_PARAMETER
                else if(rowCount%2 == 1 && type == 'p')
                    return odd_style_parameter;
            }

            init();
            
        });
    </script>
</head>



<body class="claro">
    <table border = "0">
        <col width = '100%'>
        <tr>
            <td>
                <table width="100%" style="padding-top: 10px">
                    <col width = "40%">
                    <col width = "60%">
                    <tr>
                        <td align="left" valign="bottom">
                            <button id="button_refresh_data"></button>
                        </td>
                        <td valign="bottom">
                            <h1 align = 'left'><u> Spec Reports  </u></h1>
                        </td>   
                    </tr>
                </table>
            </td>
        </tr>
        <tr>
            <td valign = "top" style = "padding: 5px; text-align:left">
                <div id="ProductSelect"></div><div id="GradeSelect"></div>
                <div id = "ReportGrid"></div>
            </td>
        </tr>
            <td colspan = "100%" style = "padding: 10px">
                <!-- <div id="serverResponse">Nothing Selected</div> -->
            </td>
        </tr>
    </table>
</body>
</html>